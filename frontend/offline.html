<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Atendentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .status-online {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .status-offline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .search-result {
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .pending-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-person-badge"></i> Check-in - Atendentes
            </a>
            <div class="ms-auto">
                <span class="navbar-text text-white me-3" id="statusConexao">
                    <i class="bi bi-wifi-off"></i> Offline
                </span>
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Status Bar -->
    <div id="statusBar" class="status-offline text-white py-2">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <small><i class="bi bi-info-circle"></i> <span id="statusText">Sistema offline - Dados ser√£o
                            sincronizados depois</span></small>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="verificarConexao()">
                        <i class="bi bi-arrow-clockwise"></i> Verificar
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="sincronizar()" id="btnSincronizar">
                        <i class="bi bi-cloud-arrow-up"></i> Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <!-- Estat√≠sticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalUsuarios">0</h3>
                        <small class="text-muted">Usu√°rios</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="bi bi-pencil-square text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalInscricoes">0</h3>
                        <small class="text-muted">Inscri√ß√µes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill text-info" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalPresencas">0</h3>
                        <small class="text-muted">Presen√ßas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                        <h3 class="mt-2 pending-badge" id="totalPendentes">0</h3>
                        <small class="text-muted">Pendentes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Abas -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checkin-tab" data-bs-toggle="tab" data-bs-target="#checkin">
                    <i class="bi bi-person-check"></i> Fazer Check-in
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro">
                    <i class="bi bi-person-plus"></i> Cadastro R√°pido
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inscricao-tab" data-bs-toggle="tab" data-bs-target="#inscricao">
                    <i class="bi bi-clipboard-plus"></i> Inscrever
                </button>
            </li>
        </ul>

        <!-- Conte√∫do das Abas -->
        <div class="tab-content">

            <!-- ABA 1: CHECK-IN -->
            <div class="tab-pane fade show active" id="checkin" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-person-check"></i> Registrar Presen√ßa</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Buscar Participante</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="buscaParticipante"
                                        placeholder="Digite nome, email ou CPF..." onkeyup="buscarParticipante()">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="eventoCheckin">
                                    <option value="">Carregando eventos...</option>
                                </select>
                            </div>
                        </div>

                        <div id="resultadosBusca" style="display: none;" class="mb-3">
                            <h6>Resultados da busca:</h6>
                            <div id="listaResultados"></div>
                        </div>

                        <div id="inscricaoSelecionada" style="display: none;" class="alert alert-info">
                            <h6><i class="bi bi-person"></i> Participante Selecionado</h6>
                            <p class="mb-0" id="infoParticipante"></p>
                            <button class="btn btn-info mt-2" onclick="confirmarCheckin()">
                                <i class="bi bi-check-circle"></i> Confirmar Presen√ßa
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 2: CADASTRO R√ÅPIDO -->
            <div class="tab-pane fade" id="cadastro" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Cadastro R√°pido na Portaria</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Para participantes n√£o cadastrados.
                            Apenas <strong>nome e email</strong> s√£o obrigat√≥rios.
                        </div>

                        <form id="formCadastro">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="cadastroNome" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" class="form-control" id="cadastroEmail" required>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Senha padr√£o:</strong> senha123 (o usu√°rio pode alterar depois no login)
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-check"></i> Cadastrar e Prosseguir
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ABA 3: INSCRI√á√ÉO -->
            <div class="tab-pane fade" id="inscricao" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-plus"></i> Inscrever Participante</h5>
                    </div>
                    <div class="card-body">
                        <form id="formInscricao">
                            <div class="mb-3">
                                <label class="form-label">Participante</label>
                                <select class="form-select" id="inscricaoUsuario" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="inscricaoEvento" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check"></i> Confirmar Inscri√ß√£o
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/offline-manager.js"></script>
    <script>
        // Configura√ß√£o do Offline Manager
        const API_BASE_URL = 'http://177.44.248.118:8000/api'; // Laravel API 
        const PYTHON_API_URL = 'http://177.44.248.118:5000'; // Python API
        
        // DEBUG: Cache-buster para for√ßar atualiza√ß√£o
        console.log('[DEBUG] Carregando offline.html - Timestamp:', new Date().getTime());
        
        // Vari√°veis globais
        let offlineManager;
        let statusOnline = false;
        let listaUsuarios = [];
        let listaInscricoes = [];
        let inscricaoAtualId = null;

        // ==================== CADASTRO R√ÅPIDO ====================
        console.log('[DEBUG] Definindo fun√ß√£o cadastrarUsuario...');
        async function cadastrarUsuario(e) {
            e.preventDefault();

            const dados = {
                nome: document.getElementById('cadastroNome').value,
                email: document.getElementById('cadastroEmail').value,
                senha: 'senha123' // Senha padr√£o para cadastro r√°pido
            };

            try {
                // Usar token do usu√°rio logado ao inv√©s do token do sistema
                const token = localStorage.getItem('token');
                if (!token) {
                    mostrarAlerta('‚ùå Voc√™ precisa estar logado para cadastrar usu√°rios!', 'danger');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/usuarios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro detalhado:', errorData);
                    
                    if (response.status === 401) {
                        mostrarAlerta('‚ùå Token expirado. Fa√ßa login novamente!', 'danger');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    
                    throw new Error(`Erro de valida√ß√£o: ${errorData.message || 'Dados inv√°lidos'}`);
                }

                const data = await response.json();
                
                // Adicionar aos dados locais
                offlineManager.dados.usuarios.push(data.data);
                offlineManager.salvarDadosNoStorage();
                
                mostrarAlerta('‚úì Usu√°rio cadastrado! Login: email | Senha: senha123', 'success');
                document.getElementById('formCadastro').reset();
                
                // Recarregar dados
                setTimeout(() => {
                    atualizarSelectUsuarios();
                    carregarEstatisticas();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao cadastrar: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        // Inicializar com callbacks
        document.addEventListener('DOMContentLoaded', async function () {
            // Verificar se usu√°rio est√° logado
            const token = localStorage.getItem('token');
            const usuario = localStorage.getItem('usuario');
            
            if (!token || !usuario) {
                mostrarAlerta('‚ùå Voc√™ precisa estar logado para acessar esta p√°gina!', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }
            
            console.log('[Offline.html] ‚úÖ Usu√°rio logado detectado');
            
            // Criar inst√¢ncia do OfflineManager
            offlineManager = new OfflineManager({
                apiBase: API_BASE_URL,
                offlineApi: PYTHON_API_URL,
                timeout: 5000,
                onStatusChange: (online) => {
                    statusOnline = online;
                    atualizarStatusBar();
                },
                onDataLoaded: (dados) => {
                    listaUsuarios = dados.usuarios;
                    listaInscricoes = dados.inscricoes;
                    atualizarUIs();
                },
                onPresencaRegistrada: (presenca) => {
                    console.log('‚úì Presen√ßa registrada:', presenca);
                    carregarEstatisticas();
                },
                onSyncStart: () => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sincronizando...';
                },
                onSyncEnd: (resultado) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(
                        `‚úÖ ${resultado.totalSincronizados} item(ns) sincronizado(s)!`,
                        resultado.erros.length > 0 ? 'warning' : 'success'
                    );
                },
                onSyncError: (erro) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(`‚ùå Erro na sincroniza√ß√£o: ${erro.message}`, 'danger');
                }
            });

            // Carregar dados inicialmente
            console.log('[Offline.html] Inicializando OfflineManager...');
            
            // Primeiro inicializar o sistema (tokens, etc)
            const inicializacao = await offlineManager.inicializar();
            if (inicializacao) {
                console.log('[Offline.html] ‚úÖ Sistema inicializado com sucesso');
            } else {
                console.warn('[Offline.html] ‚ö†Ô∏è Sistema inicializado com limita√ß√µes');
                mostrarAlerta('‚ö†Ô∏è Sistema funcionando em modo limitado - algumas funcionalidades podem n√£o estar dispon√≠veis', 'warning');
            }
            
            // Depois carregar dados
            await offlineManager.carregarTodosDados();

            // Debug: verificar se os m√©todos existem
            console.log('M√©todos dispon√≠veis no offlineManager:', Object.getOwnPropertyNames(Object.getPrototypeOf(offlineManager)));
            console.log('sincronizarPresencas existe?', typeof offlineManager.sincronizarPresencas);
            console.log('marcarPresencaOffline existe?', typeof offlineManager.marcarPresencaOffline);

            // Eventos dos formul√°rios
            console.log('[DEBUG] cadastrarUsuario existe?', typeof cadastrarUsuario);
            console.log('[DEBUG] criarInscricao existe?', typeof criarInscricao);
            document.getElementById('formCadastro')?.addEventListener('submit', cadastrarUsuario);
            document.getElementById('formInscricao')?.addEventListener('submit', criarInscricao);

            // Recarregar ao trocar de aba
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
                btn.addEventListener('shown.bs.tab', () => {
                    carregarEstatisticas();
                    atualizarSelectEventos();
                });
            });

            // Verificar conex√£o a cada 5 segundos
            setInterval(() => {
                offlineManager.verificarConexao();
            }, 5000);
        });

        // ==================== FUN√á√ïES DE ATUALIZA√á√ÉO ====================
        function atualizarStatusBar() {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const statusConexao = document.getElementById('statusConexao');

            if (statusOnline) {
                statusBar.className = 'status-online text-white py-2';
                statusText.innerHTML = '‚úì Sistema ONLINE - Dados em tempo real';
                statusConexao.innerHTML = '<i class="bi bi-wifi"></i> Online';
            } else {
                statusBar.className = 'status-offline text-white py-2';
                statusText.innerHTML = '‚óã Sistema OFFLINE - Dados em cache';
                statusConexao.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }

        function atualizarUIs() {
            atualizarSelectUsuarios();
            atualizarSelectEventos();
            carregarEstatisticas();
        }

        // ==================== CARREGAR DADOS ====================
        async function carregarDados() {
            await offlineManager.carregarTodosDados();
        }

        async function carregarEstatisticas() {
            try {
                const token = localStorage.getItem('token') || LARAVEL_TOKEN;
                const resp = await fetch(`${OFFLINE_API}/dados-pendentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!resp.ok) {
                    throw new Error('Erro na resposta da API');
                }
                
                const data = await resp.json();

                if (data.success && data.data) {
                    document.getElementById('totalUsuarios').textContent = data.data.usuarios?.length || 0;
                    document.getElementById('totalInscricoes').textContent = data.data.inscricoes?.length || 0;
                    document.getElementById('totalPresencas').textContent = data.data.presencas?.length || 0;
                    document.getElementById('totalPendentes').textContent = data.data.total_pendente || 0;
                } else {
                    // Valores padr√£o se n√£o conseguir carregar
                    document.getElementById('totalUsuarios').textContent = todosUsuarios.length || 0;
                    document.getElementById('totalInscricoes').textContent = todasInscricoes.length || 0;
                    document.getElementById('totalPresencas').textContent = 0;
                    document.getElementById('totalPendentes').textContent = 0;
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                // Valores padr√£o em caso de erro
                document.getElementById('totalUsuarios').textContent = todosUsuarios.length || 0;
                document.getElementById('totalInscricoes').textContent = todasInscricoes.length || 0;
                document.getElementById('totalPresencas').textContent = 0;
                document.getElementById('totalPendentes').textContent = 0;
            }
        }

        function atualizarSelectUsuarios() {
            const select = document.getElementById('inscricaoUsuario');
            select.innerHTML = '<option value="">Selecione um participante</option>';

            offlineManager.dados.usuarios.forEach(u => {
                select.innerHTML += `<option value="${u.id}">${u.nome} - ${u.email}</option>`;
            });
        }

        function atualizarSelectEventos() {
            const selects = [
                document.getElementById('eventoCheckin'),
                document.getElementById('inscricaoEvento')
            ];

            selects.forEach(s => {
                s.innerHTML = '<option value="">Selecione um evento</option>';
                offlineManager.dados.eventos.forEach(e => {
                    s.innerHTML += `<option value="${e.id}">${e.nome || e.titulo || e.name}</option>`;
                });
            });
        }
        // ==================== BUSCA DE PARTICIPANTE ====================
        function buscarParticipante() {
            const termo = document.getElementById('buscaParticipante').value.toLowerCase().trim();
            const resultado = document.getElementById('resultadosBusca');
            const lista = document.getElementById('listaResultados');
            const eventoId = document.getElementById('eventoCheckin').value;

            if (termo.length < 2) {
                resultado.style.display = 'none';
                return;
            }

            if (!eventoId) {
                lista.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Selecione um evento primeiro</div>';
                resultado.style.display = 'block';
                return;
            }

            // Filtrar inscri√ß√µes do evento selecionado
            const inscricoesDoEvento = offlineManager.obterInscricoesPorEvento(eventoId, true);

            // Buscar por nome, email ou CPF
            const resultados = inscricoesDoEvento.filter(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                if (!usuario) return false;

                const nome = (usuario.nome || '').toLowerCase();
                const email = (usuario.email || '').toLowerCase();
                const cpf = (usuario.cpf || '').toLowerCase().replace(/[^\d]/g, '');
                const termoLimpo = termo.replace(/[^\d]/g, '');

                return nome.includes(termo) ||
                    email.includes(termo) ||
                    (cpf && termoLimpo && cpf.includes(termoLimpo));
            });

            if (resultados.length === 0) {
                lista.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Nenhum participante encontrado neste evento</div>';
                resultado.style.display = 'block';
                return;
            }

            lista.innerHTML = '';
            resultados.forEach(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                const temPresenca = offlineManager.temPresenca(insc.id);

                lista.innerHTML += `
            <div class="card search-result mb-2 ${temPresenca ? 'bg-light' : ''}" 
                 onclick="${temPresenca ? '' : `selecionarInscricao(${insc.id})`}"
                 style="${temPresenca ? 'cursor: not-allowed; opacity: 0.6;' : ''}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${usuario.nome}</strong> - ${usuario.email}<br>
                            <small class="text-muted">
                                ${usuario.cpf ? 'CPF: ' + usuario.cpf : ''}
                            </small>
                        </div>
                        ${temPresenca ? '<span class="badge bg-success">‚úì Presen√ßa registrada</span>' : ''}
                    </div>
                </div>
            </div>
        `;
            });

            resultado.style.display = 'block';
        }

        function selecionarInscricao(inscricaoId) {
            const insc = offlineManager.obterInscricao(inscricaoId);
            const usuario = offlineManager.obterUsuario(insc.usuario_id);

            inscricaoSelecionadaId = inscricaoId;

            document.getElementById('infoParticipante').innerHTML = `
                <strong>Nome:</strong> ${usuario.nome}<br>
                <strong>Email:</strong> ${usuario.email}<br>
                <strong>Inscri√ß√£o ID:</strong> ${inscricaoId}<br>
                <small class="text-muted">Modo: ${statusOnline ? 'ONLINE' : 'OFFLINE'}</small>
            `;

            document.getElementById('inscricaoSelecionada').style.display = 'block';
        }

        // ==================== CHECK-IN ====================
        async function confirmarCheckin() {
            console.log('[CHECK-IN] üöÄ Iniciando processo de check-in');
            
            if (!inscricaoSelecionadaId) {
                mostrarAlerta('Nenhuma inscri√ß√£o selecionada!', 'warning');
                return;
            }

            const insc = offlineManager.obterInscricao(inscricaoSelecionadaId);
            console.log('[CHECK-IN] Dados da inscri√ß√£o:', insc);
            
            try {
                console.log('[CHECK-IN] Chamando marcarPresencaOffline...');
                
                // Registrar presen√ßa usando o novo m√©todo offline
                const resultado = await offlineManager.marcarPresencaOffline(
                    inscricaoSelecionadaId, 
                    insc.evento_id, 
                    insc.usuario_id
                );
                
                console.log('[CHECK-IN] üì® Resultado da marca√ß√£o:', resultado);
                
                if (resultado.success) {
                    const mensagem = resultado.servidor ? 
                        '‚úÖ Check-in realizado! Email enviado.' : 
                        '‚úì Presen√ßa registrada offline! Sincronize quando conectado.';
                    
                    mostrarAlerta(mensagem, 'success');
                    document.getElementById('buscaParticipante').value = '';
                    document.getElementById('resultadosBusca').style.display = 'none';
                    document.getElementById('inscricaoSelecionada').style.display = 'none';
                    inscricaoSelecionadaId = null;
                    
                    // Recarregar estat√≠sticas
                    setTimeout(() => {
                        document.getElementById('buscaParticipante').focus();
                        carregarEstatisticas();
                    }, 1000);
                } else {
                    mostrarAlerta('‚ö†Ô∏è Presen√ßa j√° foi registrada para esta inscri√ß√£o!', 'warning');
                }
                
            } catch (error) {
                console.error('[CHECK-IN] ‚ùå Erro capturado:', error);
                mostrarAlerta('Erro ao registrar presen√ßa: ' + error.message, 'danger');
            }
        }

        // ==================== CADASTRO R√ÅPIDO ====================
        async function cadastrarUsuario(e) {
            e.preventDefault();

            const dados = {
                nome: document.getElementById('cadastroNome').value,
                email: document.getElementById('cadastroEmail').value,
                senha: 'senha123' // Senha padr√£o para cadastro r√°pido
            };

            try {
                // Usar token do usu√°rio logado ao inv√©s do token do sistema
                const token = localStorage.getItem('token') || LARAVEL_TOKEN;
                
                const response = await fetch(`${LARAVEL_API}/usuarios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro detalhado:', errorData);
                    
                    if (response.status === 401) {
                        mostrarAlerta('‚ùå Token expirado. Fa√ßa login novamente!', 'danger');
                        return;
                    }
                    
                    throw new Error(`Erro de valida√ß√£o: ${errorData.message || 'Dados inv√°lidos'}`);
                }

                const data = await response.json();
                
                mostrarAlerta('‚úì Usu√°rio cadastrado! Login: email | Senha: senha123', 'success');
                document.getElementById('formCadastro').reset();
                
                // Recarregar dados
                setTimeout(() => {
                    carregarDados();
                    document.getElementById('inscricao-tab').click();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao cadastrar: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        // ==================== INSCRI√á√ÉO ====================
        async function criarInscricao(e) {
            e.preventDefault();

            const usuarioId = parseInt(document.getElementById('inscricaoUsuario').value);
            const eventoId = parseInt(document.getElementById('inscricaoEvento').value);

            if (!usuarioId || !eventoId) {
                mostrarAlerta('Selecione um participante e um evento!', 'warning');
                return;
            }

            try {
                // Usar token do usu√°rio logado ao inv√©s do token do sistema
                let token = localStorage.getItem('token');
                if (!token) {
                    mostrarAlerta('‚ùå Voc√™ precisa estar logado para criar inscri√ß√µes!', 'danger');
                    return;
                }
                console.log('[INSCRICAO] Token de usu√°rio obtido:', token ? '‚úÖ' : '‚ùå');

                let response = await fetch(`${API_BASE_URL}/inscricoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        usuario_id: usuarioId,
                        evento_id: eventoId,
                        status: 'ativa'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('[INSCRICAO] Erro HTTP:', response.status, errorData);
                    
                    if (response.status === 401) {
                        mostrarAlerta('‚ùå Token expirado. Fa√ßa login novamente!', 'danger');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    
                    throw new Error(`Erro ${response.status}: ${errorData.message || 'Falha na inscri√ß√£o'}`);
                }

                const data = await response.json();
                console.log('[INSCRICAO] ‚úÖ Inscri√ß√£o criada:', data);
                
                // Adicionar aos dados locais
                offlineManager.dados.inscricoes.push(data.data);
                offlineManager.salvarDadosNoStorage();
                
                mostrarAlerta('‚úì Inscri√ß√£o realizada! Agora pode fazer o check-in.', 'success');
                document.getElementById('formInscricao').reset();
                
                // Recarregar dados e ir para check-in
                setTimeout(async () => {
                    await carregarDados();
                    document.getElementById('checkin-tab').click();
                    carregarEstatisticas();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao criar inscri√ß√£o: ' + error.message, 'danger');
                console.error('[INSCRICAO] ‚ùå Erro:', error);
            }
        }

        // ==================== SINCRONIZAR ====================
        async function sincronizar() {
            if (!statusOnline) {
                mostrarAlerta('‚ö†Ô∏è Sistema offline! Conecte-se √† internet primeiro.', 'warning');
                return;
            }

            try {
                // Sincronizar especificamente as presen√ßas offline
                const resultado = await offlineManager.sincronizarPresencas();
                
                if (resultado.sucesso) {
                    mostrarAlerta(
                        `‚úÖ Sincroniza√ß√£o completa!\n${resultado.sincronizadas} presen√ßa(s) sincronizada(s)\n${resultado.sincronizadas} certificado(s) gerado(s)`,
                        'success'
                    );
                } else {
                    mostrarAlerta(
                        `‚ö†Ô∏è Sincroniza√ß√£o parcial!\n${resultado.sincronizadas} sucesso, ${resultado.erros} erro(s)`,
                        'warning'
                    );
                }

                // Recarregar dados
                await carregarDados();
                
            } catch (error) {
                mostrarAlerta('‚ùå Erro ao sincronizar: ' + error.message, 'danger');
            }
        }

        // ==================== VERIFICAR CONEX√ÉO ====================
        async function verificarConexao() {
            await offlineManager.verificarConexao();
        }

        // ==================== UTILIT√ÅRIOS ====================
        function mostrarAlerta(msg, tipo) {
            const c = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            c.innerHTML = `
                <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show">
                    ${msg.replace(/\n/g, '<br>')}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        console.log('[DEBUG] Todas as fun√ß√µes carregadas com sucesso!');
    </script>
</body>

</html>
