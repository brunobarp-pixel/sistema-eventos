<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Atendentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .status-online {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .status-offline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .search-result {
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .pending-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-person-badge"></i> Check-in - Atendentes
            </a>
            <div class="ms-auto">
                <span class="navbar-text text-white me-3" id="statusConexao">
                    <i class="bi bi-wifi-off"></i> Offline
                </span>
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Status Bar -->
    <div id="statusBar" class="status-offline text-white py-2">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <small><i class="bi bi-info-circle"></i> <span id="statusText">Sistema offline - Dados serão
                            sincronizados depois</span></small>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="verificarConexao()">
                        <i class="bi bi-arrow-clockwise"></i> Verificar
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="sincronizar()" id="btnSincronizar">
                        <i class="bi bi-cloud-arrow-up"></i> Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalUsuarios">0</h3>
                        <small class="text-muted">Usuários</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="bi bi-pencil-square text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalInscricoes">0</h3>
                        <small class="text-muted">Inscrições</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill text-info" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalPresencas">0</h3>
                        <small class="text-muted">Presenças</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                        <h3 class="mt-2 pending-badge" id="totalPendentes">0</h3>
                        <small class="text-muted">Pendentes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Abas -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checkin-tab" data-bs-toggle="tab" data-bs-target="#checkin">
                    <i class="bi bi-person-check"></i> Fazer Check-in
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro">
                    <i class="bi bi-person-plus"></i> Cadastro Rápido
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inscricao-tab" data-bs-toggle="tab" data-bs-target="#inscricao">
                    <i class="bi bi-clipboard-plus"></i> Inscrever
                </button>
            </li>
        </ul>

        <!-- Conteúdo das Abas -->
        <div class="tab-content">

            <!-- ABA 1: CHECK-IN -->
            <div class="tab-pane fade show active" id="checkin" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-person-check"></i> Registrar Presença</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Buscar Participante</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="buscaParticipante"
                                        placeholder="Digite nome, email ou CPF..." onkeyup="buscarParticipante()">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="eventoCheckin">
                                    <option value="">Carregando eventos...</option>
                                </select>
                            </div>
                        </div>

                        <div id="resultadosBusca" style="display: none;" class="mb-3">
                            <h6>Resultados da busca:</h6>
                            <div id="listaResultados"></div>
                        </div>

                        <div id="inscricaoSelecionada" style="display: none;" class="alert alert-info">
                            <h6><i class="bi bi-person"></i> Participante Selecionado</h6>
                            <p class="mb-0" id="infoParticipante"></p>
                            <button class="btn btn-info mt-2" onclick="confirmarCheckin()">
                                <i class="bi bi-check-circle"></i> Confirmar Presença
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 2: CADASTRO RÁPIDO -->
            <div class="tab-pane fade" id="cadastro" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Cadastro Rápido na Portaria</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Para participantes não cadastrados.
                            Apenas <strong>nome e email</strong> são obrigatórios.
                        </div>

                        <form id="formCadastro">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="cadastroNome" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" class="form-control" id="cadastroEmail" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CPF</label>
                                    <input type="text" class="form-control" id="cadastroCpf" maxlength="14">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="cadastroTelefone" maxlength="15">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-check"></i> Cadastrar e Prosseguir
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ABA 3: INSCRIÇÃO -->
            <div class="tab-pane fade" id="inscricao" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-plus"></i> Inscrever Participante</h5>
                    </div>
                    <div class="card-body">
                        <form id="formInscricao">
                            <div class="mb-3">
                                <label class="form-label">Participante</label>
                                <select class="form-select" id="inscricaoUsuario" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="inscricaoEvento" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check"></i> Confirmar Inscrição
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/offline-manager.js"></script>
    <script>
        // Configuração do Offline Manager
        const API_BASE_URL = 'http://localhost:8000/api'; // Ajuste conforme necessário
        
        let offlineManager;
        let modoOnline = false;
        let todosUsuarios = [];
        let todasInscricoes = [];
        let inscricaoSelecionadaId = null;

        let modoOnline = false;
        let todosUsuarios = [];
        let todasInscricoes = [];
        let inscricaoSelecionadaId = null;

        // Inicializar com callbacks
        document.addEventListener('DOMContentLoaded', async function () {
            // Criar instância do OfflineManager
            offlineManager = new OfflineManager({
                apiBase: API_BASE_URL,
                timeout: 5000,
                onStatusChange: (online) => {
                    modoOnline = online;
                    atualizarStatusBar();
                },
                onDataLoaded: (dados) => {
                    todosUsuarios = dados.usuarios;
                    todasInscricoes = dados.inscricoes;
                    atualizarUIs();
                },
                onPresencaRegistrada: (presenca) => {
                    console.log('✓ Presença registrada:', presenca);
                    carregarEstatisticas();
                },
                onSyncStart: () => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sincronizando...';
                },
                onSyncEnd: (resultado) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(
                        `✅ ${resultado.totalSincronizados} item(ns) sincronizado(s)!`,
                        resultado.erros.length > 0 ? 'warning' : 'success'
                    );
                },
                onSyncError: (erro) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(`❌ Erro na sincronização: ${erro.message}`, 'danger');
                }
            });

            // Carregar dados inicialmente
            await offlineManager.carregarTodosDados();

            // Eventos dos formulários
            document.getElementById('formCadastro')?.addEventListener('submit', cadastrarUsuario);
            document.getElementById('formInscricao')?.addEventListener('submit', criarInscricao);

            // Recarregar ao trocar de aba
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
                btn.addEventListener('shown.bs.tab', () => {
                    carregarEstatisticas();
                    atualizarSelectEventos();
                });
            });

            // Verificar conexão a cada 5 segundos
            setInterval(() => {
                offlineManager.verificarConexao();
            }, 5000);
        });

        // ==================== FUNÇÕES DE ATUALIZAÇÃO ====================
        function atualizarStatusBar() {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const statusConexao = document.getElementById('statusConexao');

            if (modoOnline) {
                statusBar.className = 'status-online text-white py-2';
                statusText.innerHTML = '✓ Sistema ONLINE - Dados em tempo real';
                statusConexao.innerHTML = '<i class="bi bi-wifi"></i> Online';
            } else {
                statusBar.className = 'status-offline text-white py-2';
                statusText.innerHTML = '○ Sistema OFFLINE - Dados em cache';
                statusConexao.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }

        function atualizarUIs() {
            atualizarSelectUsuarios();
            atualizarSelectEventos();
            carregarEstatisticas();
        }

        // ==================== CARREGAR DADOS ====================
        async function carregarDados() {
            await offlineManager.carregarTodosDados();
        }

        async function carregarEstatisticas() {
            const stats = offlineManager.obterEstatisticas();
            document.getElementById('totalUsuarios').textContent = stats.totalUsuarios;
            document.getElementById('totalInscricoes').textContent = stats.totalInscricoes;
            document.getElementById('totalPresencas').textContent = stats.totalPresencas;
            document.getElementById('totalPendentes').textContent = stats.totalPendentes;
        }

        function atualizarSelectUsuarios() {
            const select = document.getElementById('inscricaoUsuario');
            select.innerHTML = '<option value="">Selecione um participante</option>';

            offlineManager.dados.usuarios.forEach(u => {
                select.innerHTML += `<option value="${u.id}">${u.nome} - ${u.email}</option>`;
            });
        }

        function atualizarSelectEventos() {
            const selects = [
                document.getElementById('eventoCheckin'),
                document.getElementById('inscricaoEvento')
            ];

            selects.forEach(s => {
                s.innerHTML = '<option value="">Selecione um evento</option>';
                offlineManager.dados.eventos.forEach(e => {
                    s.innerHTML += `<option value="${e.id}">${e.titulo || e.name}</option>`;
                });
            });
        }
        // ==================== BUSCA DE PARTICIPANTE ====================
        function buscarParticipante() {
            const termo = document.getElementById('buscaParticipante').value.toLowerCase().trim();
            const resultado = document.getElementById('resultadosBusca');
            const lista = document.getElementById('listaResultados');
            const eventoId = document.getElementById('eventoCheckin').value;

            if (termo.length < 2) {
                resultado.style.display = 'none';
                return;
            }

            if (!eventoId) {
                lista.innerHTML = '<div class="alert alert-warning">⚠️ Selecione um evento primeiro</div>';
                resultado.style.display = 'block';
                return;
            }

            // Filtrar inscrições do evento selecionado
            const inscricoesDoEvento = offlineManager.obterInscricoesPorEvento(eventoId, true);

            // Buscar por nome, email ou CPF
            const resultados = inscricoesDoEvento.filter(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                if (!usuario) return false;

                const nome = (usuario.nome || '').toLowerCase();
                const email = (usuario.email || '').toLowerCase();
                const cpf = (usuario.cpf || '').toLowerCase().replace(/[^\d]/g, '');
                const termoLimpo = termo.replace(/[^\d]/g, '');

                return nome.includes(termo) ||
                    email.includes(termo) ||
                    (cpf && termoLimpo && cpf.includes(termoLimpo));
            });

            if (resultados.length === 0) {
                lista.innerHTML = '<div class="alert alert-warning">⚠️ Nenhum participante encontrado neste evento</div>';
                resultado.style.display = 'block';
                return;
            }

            lista.innerHTML = '';
            resultados.forEach(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                const temPresenca = offlineManager.temPresenca(insc.id);

                lista.innerHTML += `
            <div class="card search-result mb-2 ${temPresenca ? 'bg-light' : ''}" 
                 onclick="${temPresenca ? '' : `selecionarInscricao(${insc.id})`}"
                 style="${temPresenca ? 'cursor: not-allowed; opacity: 0.6;' : ''}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${usuario.nome}</strong> - ${usuario.email}<br>
                            <small class="text-muted">
                                ${usuario.cpf ? 'CPF: ' + usuario.cpf : ''}
                            </small>
                        </div>
                        ${temPresenca ? '<span class="badge bg-success">✓ Presença registrada</span>' : ''}
                    </div>
                </div>
            </div>
        `;
            });

            resultado.style.display = 'block';
        }

        function selecionarInscricao(inscricaoId) {
            const insc = offlineManager.obterInscricao(inscricaoId);
            const usuario = offlineManager.obterUsuario(insc.usuario_id);

            inscricaoSelecionadaId = inscricaoId;

            document.getElementById('infoParticipante').innerHTML = `
                <strong>Nome:</strong> ${usuario.nome}<br>
                <strong>Email:</strong> ${usuario.email}<br>
                <strong>Inscrição ID:</strong> ${inscricaoId}<br>
                <small class="text-muted">Modo: ${modoOnline ? 'ONLINE' : 'OFFLINE'}</small>
            `;

            document.getElementById('inscricaoSelecionada').style.display = 'block';
        }

        // ==================== CHECK-IN ====================
        async function confirmarCheckin() {
            if (!inscricaoSelecionadaId) {
                mostrarAlerta('Nenhuma inscrição selecionada!', 'warning');
                return;
            }

            const insc = offlineManager.obterInscricao(inscricaoSelecionadaId);
            
            try {
                // Registrar presença através do OfflineManager
                await offlineManager.registrarPresenca(inscricaoSelecionadaId, insc.evento_id);
                
                mostrarAlerta('✓ Presença registrada com sucesso!', 'success');
                document.getElementById('buscaParticipante').value = '';
                document.getElementById('resultadosBusca').style.display = 'none';
                document.getElementById('inscricaoSelecionada').style.display = 'none';
                inscricaoSelecionadaId = null;
                
                // Recarregar estatísticas
                setTimeout(() => {
                    document.getElementById('buscaParticipante').focus();
                    carregarEstatisticas();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao registrar presença: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        // ==================== CADASTRO RÁPIDO ====================
        async function cadastrarUsuario(e) {
            e.preventDefault();

            const dados = {
                nome: document.getElementById('cadastroNome').value,
                email: document.getElementById('cadastroEmail').value,
                cpf: document.getElementById('cadastroCpf').value,
                telefone: document.getElementById('cadastroTelefone').value,
                password: 'senha_temporaria_123' // Senha temporária
            };

            try {
                const response = await fetch(`${API_BASE_URL}/usuarios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${offlineManager.getToken()}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    throw new Error('Erro ao cadastrar usuário');
                }

                const data = await response.json();
                
                // Adicionar aos dados locais
                offlineManager.dados.usuarios.push(data.data);
                offlineManager.salvarDadosNoStorage();
                
                mostrarAlerta('✓ Usuário cadastrado com sucesso!', 'success');
                document.getElementById('formCadastro').reset();
                
                // Recarregar dados
                setTimeout(() => {
                    atualizarSelectUsuarios();
                    document.getElementById('cadastro-tab').classList.remove('active');
                    document.getElementById('inscricao-tab').classList.add('active');
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao cadastrar: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        // ==================== INSCRIÇÃO ====================
        async function criarInscricao(e) {
            e.preventDefault();

            const usuarioId = parseInt(document.getElementById('inscricaoUsuario').value);
            const eventoId = parseInt(document.getElementById('inscricaoEvento').value);

            if (!usuarioId || !eventoId) {
                mostrarAlerta('Selecione um participante e um evento!', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/inscricoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${offlineManager.getToken()}`
                    },
                    body: JSON.stringify({
                        usuario_id: usuarioId,
                        evento_id: eventoId,
                        status: 'ativa'
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao criar inscrição');
                }

                const data = await response.json();
                
                // Adicionar aos dados locais
                offlineManager.dados.inscricoes.push(data.data);
                offlineManager.salvarDadosNoStorage();
                
                mostrarAlerta('✓ Inscrição realizada! Agora pode fazer o check-in.', 'success');
                document.getElementById('formInscricao').reset();
                
                // Ir para aba de check-in
                setTimeout(() => {
                    document.getElementById('checkin-tab').click();
                    carregarEstatisticas();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao criar inscrição: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        // ==================== SINCRONIZAR ====================
        async function sincronizar() {
            if (!modoOnline) {
                mostrarAlerta('⚠️ Sistema offline! Conecte-se à internet primeiro.', 'warning');
                return;
            }

            try {
                const resultado = await offlineManager.sincronizarTodos();
                
                mostrarAlerta(
                    `✅ Sincronização completa!\n${resultado.totalSincronizados} item(ns) sincronizado(s)`,
                    resultado.erros.length > 0 ? 'warning' : 'success'
                );

                // Recarregar dados
                await carregarDados();
                
            } catch (error) {
                mostrarAlerta('❌ Erro ao sincronizar: ' + error.message, 'danger');
            }
        }

        // ==================== VERIFICAR CONEXÃO ====================
        async function verificarConexao() {
            await offlineManager.verificarConexao();
        }

        // ==================== UTILITÁRIOS ====================
        function mostrarAlerta(msg, tipo) {
            const c = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            c.innerHTML = `
                <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show">
                    ${msg.replace(/\n/g, '<br>')}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        // Máscaras de entrada
        document.addEventListener('DOMContentLoaded', function() {
            const inputCpf = document.getElementById('cadastroCpf');
            const inputTelefone = document.getElementById('cadastroTelefone');

            if (inputCpf) {
                inputCpf.addEventListener('input', function (e) {
                    let v = e.target.value.replace(/\D/g, '');
                    v = v.replace(/(\d{3})(\d)/, '$1.$2');
                    v = v.replace(/(\d{3})(\d)/, '$1.$2');
                    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    e.target.value = v;
                });
            }

            if (inputTelefone) {
                inputTelefone.addEventListener('input', function (e) {
                    let v = e.target.value.replace(/\D/g, '');
                    v = v.replace(/(\d{2})(\d)/, '($1) $2');
                    v = v.replace(/(\d{5})(\d)/, '$1-$2');
                    e.target.value = v;
                });
            }
        });
    </script>
</body>

</html>
