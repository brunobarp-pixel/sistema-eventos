<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Atendentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .status-online {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .status-offline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .search-result {
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .pending-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-person-badge"></i> Check-in - Atendentes
            </a>
            <div class="ms-auto">
                <span class="navbar-text text-white me-3" id="statusConexao">
                    <i class="bi bi-wifi-off"></i> Offline
                </span>
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </nav>

    <div id="statusBar" class="status-offline text-white py-2">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <small><i class="bi bi-info-circle"></i> <span id="statusText">Sistema offline - Dados ser√£o
                            sincronizados depois</span></small>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="verificarConexao()">
                        <i class="bi bi-arrow-clockwise"></i> Verificar
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="sincronizar()" id="btnSincronizar">
                        <i class="bi bi-cloud-arrow-up"></i> Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalUsuarios">0</h3>
                        <small class="text-muted">Usu√°rios</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="bi bi-pencil-square text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalInscricoes">0</h3>
                        <small class="text-muted">Inscri√ß√µes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill text-info" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalPresencas">0</h3>
                        <small class="text-muted">Presen√ßas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                        <h3 class="mt-2 pending-badge" id="totalPendentes">0</h3>
                        <small class="text-muted">Pendentes</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checkin-tab" data-bs-toggle="tab" data-bs-target="#checkin">
                    <i class="bi bi-person-check"></i> Fazer Check-in
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro">
                    <i class="bi bi-person-plus"></i> Cadastro R√°pido
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inscricao-tab" data-bs-toggle="tab" data-bs-target="#inscricao">
                    <i class="bi bi-clipboard-plus"></i> Inscrever
                </button>
            </li>
        </ul>

        <div class="tab-content">

            <div class="tab-pane fade show active" id="checkin" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-person-check"></i> Registrar Presen√ßa</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Buscar Participante</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="buscaParticipante"
                                        placeholder="Digite nome, email ou CPF..." onkeyup="buscarParticipante()">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="eventoCheckin">
                                    <option value="">Carregando eventos...</option>
                                </select>
                            </div>
                        </div>

                        <div id="resultadosBusca" style="display: none;" class="mb-3">
                            <h6>Resultados da busca:</h6>
                            <div id="listaResultados"></div>
                        </div>

                        <div id="inscricaoSelecionada" style="display: none;" class="alert alert-info">
                            <h6><i class="bi bi-person"></i> Participante Selecionado</h6>
                            <p class="mb-0" id="infoParticipante"></p>
                            <button class="btn btn-info mt-2" onclick="confirmarCheckin()">
                                <i class="bi bi-check-circle"></i> Confirmar Presen√ßa
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="cadastro" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Cadastro R√°pido na Portaria</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Para participantes n√£o cadastrados.
                            Apenas <strong>nome e email</strong> s√£o obrigat√≥rios.
                        </div>

                        <form id="formCadastro">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="cadastroNome" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" class="form-control" id="cadastroEmail" required>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Senha padr√£o:</strong> senha123 (o usu√°rio pode alterar depois no login)
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-check"></i> Cadastrar e Prosseguir
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="inscricao" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-plus"></i> Inscrever Participante</h5>
                    </div>
                    <div class="card-body">
                        <form id="formInscricao">
                            <div class="mb-3">
                                <label class="form-label">Participante</label>
                                <select class="form-select" id="inscricaoUsuario" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="inscricaoEvento" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check"></i> Confirmar Inscri√ß√£o
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/offline-manager.js"></script>
    <script>
        const API_BASE_URL = 'http://177.44.248.118:8000/api'; // Laravel API principal
        const PYTHON_API_URL = 'http://177.44.248.118:5000'; // Python API (manter compatibilidade)
        const OFFLINE_API_URL = 'http://177.44.248.118:8081/api'; // Novo Backend Offline
        const LARAVEL_API = 'http://177.44.248.118:8000/api'; // Alias para compatibilidade
        const OFFLINE_API = 'http://177.44.248.118:8081/api'; // Novo endpoint offline
        const LARAVEL_TOKEN = '70|VaI5IynnhSWh5OcaRzbL4mZq4WnXSjPDf003cqSE65c407fe';
        
        console.log('Carregando offline.html - Timestamp:', new Date().getTime());
        console.log('APIs configuradas:', {
            laravel: LARAVEL_API,
            python: OFFLINE_API
        });
        
        //  globais
        let offlineManager;
        let statusOnline = false;
        let listaUsuarios = [];
        let listaInscricoes = [];
        let inscricaoAtualId = null;
        let inscricaoSelecionadaId = null; // Vari√°vel para armazenar inscri√ß√£o selecionada
        let todosUsuarios = []; // Para compatibilidade com estat√≠sticas
        let todasInscricoes = []; // Para compatibilidade com estat√≠sticas

        // Fun√ß√µes globais
        async function cadastrarUsuario(e) {
            e.preventDefault();

            const dados = {
                nome: document.getElementById('cadastroNome').value,
                email: document.getElementById('cadastroEmail').value,
                senha: 'senha123' 
            };

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    mostrarAlerta('Voc√™ precisa estar logado para cadastrar usu√°rios!', 'danger');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/usuarios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro detalhado:', errorData);
                    
                    if (response.status === 401) {
                        mostrarAlerta('Token expirado. Fa√ßa login novamente!', 'danger');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    
                    throw new Error(`Erro de valida√ß√£o: ${errorData.message || 'Dados inv√°lidos'}`);
                }

                const data = await response.json();
                
                if (offlineManager && offlineManager.dados) {
                    offlineManager.dados.usuarios.push(data.data);
                    offlineManager.salvarDadosNoStorage();
                }
                
                mostrarAlerta('Usu√°rio cadastrado! Login: email | Senha: senha123', 'success');
                document.getElementById('formCadastro').reset();
                
                setTimeout(() => {
                    atualizarSelectUsuarios();
                    carregarEstatisticas();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao cadastrar: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('token');
            const usuario = localStorage.getItem('usuario');
            
            if (!token || !usuario) {
                mostrarAlerta('Voc√™ precisa estar logado para acessar esta p√°gina!', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }
            
            console.log('Usu√°rio logado detectado');
            
            console.log('üöÄ Inicializando sistema offline...');
            console.log('üì° Conectando com backend-offline em:', OFFLINE_API);
            
            offlineManager = new OfflineManager({
                apiBase: API_BASE_URL,
                offlineApi: PYTHON_API_URL,
                timeout: 5000,
                onStatusChange: (online) => {
                    statusOnline = online;
                    atualizarStatusBar();
                },
                onDataLoaded: (dados) => {
                    console.log('üì• Dados carregados para localStorage:', {
                        eventos: dados.eventos?.length || 0,
                        usuarios: dados.usuarios?.length || 0,
                        inscricoes: dados.inscricoes?.length || 0,
                        presencas: dados.presencas?.length || 0
                    });
                    
                    listaUsuarios = dados.usuarios || [];
                    listaInscricoes = dados.inscricoes || [];
                    atualizarUIs();
                },
                onPresencaRegistrada: (presenca) => {
                    console.log('Presen√ßa registrada:', presenca);
                    carregarEstatisticas();
                },
                onSyncStart: () => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sincronizando...';
                },
                onSyncEnd: (resultado) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(
                        ` ${resultado.totalSincronizados} item(ns) sincronizado(s)!`,
                        resultado.erros.length > 0 ? 'warning' : 'success'
                    );
                },
                onSyncError: (erro) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(`Erro na sincroniza√ß√£o: ${erro.message}`, 'danger');
                }
            });

            
            const inicializacao = await offlineManager.inicializar();
            if (inicializacao) {
                console.log('‚úÖ Sistema inicializado com sucesso');
            } else {
                console.warn('‚ö†Ô∏è Sistema inicializado com limita√ß√µes');
                mostrarAlerta('Sistema funcionando em modo limitado - algumas funcionalidades podem n√£o estar dispon√≠veis', 'warning');
            }
            
            console.log('üì¶ Carregando dados do servidor para localStorage...');
            await offlineManager.carregarTodosDados();
            console.log('‚úÖ Dados carregados no localStorage');

            console.log('üîß M√©todos dispon√≠veis no offlineManager:', Object.getOwnPropertyNames(Object.getPrototypeOf(offlineManager)));
            console.log('üîÑ sincronizarPresencas existe?', typeof offlineManager.sincronizarPresencas);
            console.log('‚úèÔ∏è marcarPresencaOffline existe?', typeof offlineManager.marcarPresencaOffline);

            console.log('cadastrarUsuario existe?', typeof cadastrarUsuario);
            console.log('criarInscricao existe?', typeof criarInscricao);
            document.getElementById('formCadastro')?.addEventListener('submit', cadastrarUsuario);
            document.getElementById('formInscricao')?.addEventListener('submit', criarInscricao);

            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
                btn.addEventListener('shown.bs.tab', () => {
                    carregarEstatisticas();
                    atualizarSelectEventos();
                });
            });

            setInterval(() => {
                offlineManager.verificarConexao();
            }, 5000);
        });

        function atualizarStatusBar() {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const statusConexao = document.getElementById('statusConexao');

            if (statusOnline) {
                statusBar.className = 'status-online text-white py-2';
                statusText.innerHTML = 'Sistema ONLINE - Dados em tempo real';
                statusConexao.innerHTML = '<i class="bi bi-wifi"></i> Online';
            } else {
                statusBar.className = 'status-offline text-white py-2';
                statusText.innerHTML = '‚óã Sistema OFFLINE - Dados em cache';
                statusConexao.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }

        function atualizarUIs() {
            atualizarSelectUsuarios();
            atualizarSelectEventos();
            carregarEstatisticas();
        }

        async function carregarDados() {
            await offlineManager.carregarTodosDados();
        }

        async function carregarEstatisticas() {
            try {
                console.log('üìä Carregando estat√≠sticas...', { offlineManager: !!offlineManager });
                
                // Tentar carregar estat√≠sticas do novo backend-offline
                if (statusOnline) {
                    try {
                        const resp = await fetch(`${OFFLINE_API}/offline/status`, {
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (resp.ok) {
                            const data = await resp.json();
                            console.log('Status do backend-offline:', data);
                        }
                    } catch (error) {
                        console.warn('Erro ao consultar backend-offline:', error);
                    }
                }
                
                // Verificar se offlineManager existe e tem dados
                if (!offlineManager || !offlineManager.dados) {
                    console.warn('OfflineManager ainda n√£o inicializado');
                    document.getElementById('totalUsuarios').textContent = 0;
                    document.getElementById('totalInscricoes').textContent = 0;
                    document.getElementById('totalPresencas').textContent = 0;
                    document.getElementById('totalPendentes').textContent = 0;
                    return;
                }
                
                // Usar dados do offlineManager para estat√≠sticas
                const usuarios = offlineManager.dados.usuarios || [];
                const inscricoes = offlineManager.dados.inscricoes || [];
                const presencas = offlineManager.dados.presencas || [];
                
                // Calcular presen√ßas pendentes
                const presencasOffline = JSON.parse(localStorage.getItem('presencas_offline') || '[]');
                const totalPendentes = presencasOffline.filter(p => !p.sincronizado).length;
                
                console.log('üìä Estat√≠sticas atualizadas:', {
                    usuarios: usuarios.length,
                    inscricoes: inscricoes.length,
                    presencas: presencas.length,
                    pendentes: totalPendentes
                });
                
                document.getElementById('totalUsuarios').textContent = usuarios.length || 0;
                document.getElementById('totalInscricoes').textContent = inscricoes.length || 0;
                document.getElementById('totalPresencas').textContent = presencas.length || 0;
                document.getElementById('totalPendentes').textContent = totalPendentes || 0;
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                // Fallback para valores padr√£o
                document.getElementById('totalUsuarios').textContent = 0;
                document.getElementById('totalInscricoes').textContent = 0;
                document.getElementById('totalPresencas').textContent = 0;
                document.getElementById('totalPendentes').textContent = 0;
            }
        }

        function atualizarSelectUsuarios() {
            const select = document.getElementById('inscricaoUsuario');
            select.innerHTML = '<option value="">Selecione um participante</option>';

            offlineManager.dados.usuarios.forEach(u => {
                select.innerHTML += `<option value="${u.id}">${u.nome} - ${u.email}</option>`;
            });
        }

        function atualizarSelectEventos() {
            const selects = [
                document.getElementById('eventoCheckin'),
                document.getElementById('inscricaoEvento')
            ];

            selects.forEach(s => {
                s.innerHTML = '<option value="">Selecione um evento</option>';
                if (offlineManager && offlineManager.dados && offlineManager.dados.eventos) {
                    offlineManager.dados.eventos.forEach(e => {
                        const nomeEvento = e.nome || e.titulo || e.name || 'Evento sem nome';
                        s.innerHTML += `<option value="${e.id}">${nomeEvento}</option>`;
                        console.log('üé´ Evento adicionado ao select:', { id: e.id, nome: nomeEvento });
                    });
                }
            });
            
            // Adicionar listener para mostrar inscri√ß√µes quando evento for selecionado
            const eventoCheckin = document.getElementById('eventoCheckin');
            eventoCheckin.addEventListener('change', mostrarInscricoesDoEvento);
        }
        
        function mostrarInscricoesDoEvento() {
            const eventoId = document.getElementById('eventoCheckin').value;
            const resultadosBusca = document.getElementById('resultadosBusca');
            const listaResultados = document.getElementById('listaResultados');
            
            if (!eventoId) {
                resultadosBusca.style.display = 'none';
                return;
            }
            
            console.log('üîç Mostrando todas as inscri√ß√µes do evento:', eventoId);
            
            if (!offlineManager || !offlineManager.dados) {
                listaResultados.innerHTML = '<div class="alert alert-warning">Dados ainda carregando...</div>';
                resultadosBusca.style.display = 'block';
                return;
            }
            
            const inscricoesDoEvento = offlineManager.obterInscricoesPorEvento(eventoId, true);
            
            if (inscricoesDoEvento.length === 0) {
                listaResultados.innerHTML = '<div class="alert alert-info">Nenhum participante inscrito neste evento</div>';
                resultadosBusca.style.display = 'block';
                return;
            }
            
            listaResultados.innerHTML = '';
            inscricoesDoEvento.forEach(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                const temPresenca = offlineManager.temPresenca(insc.id);
                
                listaResultados.innerHTML += `
                <div class="card search-result mb-2 ${temPresenca ? 'bg-light' : ''}" 
                     onclick="${temPresenca ? '' : `selecionarInscricao(${insc.id})`}"
                     style="${temPresenca ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;'}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${usuario.nome}</strong> - ${usuario.email}<br>
                                <small class="text-muted">
                                    ${usuario.cpf ? 'CPF: ' + usuario.cpf : ''}
                                </small>
                            </div>
                            ${temPresenca ? '<span class="badge bg-success">‚úì Presen√ßa registrada</span>' : '<span class="badge bg-primary">Clique para marcar presen√ßa</span>'}
                        </div>
                    </div>
                </div>
            `;
            });
            
            resultadosBusca.style.display = 'block';
            console.log(`üìã Exibindo ${inscricoesDoEvento.length} inscri√ß√µes do evento`);
        }
        function buscarParticipante() {
            const termo = document.getElementById('buscaParticipante').value.toLowerCase().trim();
            const resultado = document.getElementById('resultadosBusca');
            const lista = document.getElementById('listaResultados');
            const eventoId = document.getElementById('eventoCheckin').value;

            if (termo.length < 2) {
                // Se n√£o h√° termo de busca, mostrar todos do evento se um evento estiver selecionado
                if (eventoId) {
                    mostrarInscricoesDoEvento();
                } else {
                    resultado.style.display = 'none';
                }
                return;
            }

            if (!eventoId) {
                lista.innerHTML = '<div class="alert alert-warning">Selecione um evento primeiro</div>';
                resultado.style.display = 'block';
                return;
            }

            console.log('üîç Buscando participante:', termo, 'no evento:', eventoId);

            const inscricoesDoEvento = offlineManager.obterInscricoesPorEvento(eventoId, true);

            const resultados = inscricoesDoEvento.filter(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                if (!usuario) return false;

                const nome = (usuario.nome || '').toLowerCase();
                const email = (usuario.email || '').toLowerCase();
                const cpf = (usuario.cpf || '').toLowerCase().replace(/[^\d]/g, '');
                const termoLimpo = termo.replace(/[^\d]/g, '');

                return nome.includes(termo) ||
                    email.includes(termo) ||
                    (cpf && termoLimpo && cpf.includes(termoLimpo));
            });

            if (resultados.length === 0) {
                lista.innerHTML = '<div class="alert alert-warning">Nenhum participante encontrado neste evento com este termo</div>';
                resultado.style.display = 'block';
                return;
            }

            lista.innerHTML = '';
            resultados.forEach(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                const temPresenca = offlineManager.temPresenca(insc.id);

                lista.innerHTML += `
            <div class="card search-result mb-2 ${temPresenca ? 'bg-light' : ''}" 
                 onclick="${temPresenca ? '' : `selecionarInscricao(${insc.id})`}"
                 style="${temPresenca ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;'}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${usuario.nome}</strong> - ${usuario.email}<br>
                            <small class="text-muted">
                                ${usuario.cpf ? 'CPF: ' + usuario.cpf : ''}
                            </small>
                        </div>
                        ${temPresenca ? '<span class="badge bg-success">‚úì Presen√ßa registrada</span>' : '<span class="badge bg-primary">Clique para marcar presen√ßa</span>'}
                    </div>
                </div>
            </div>
        `;
            });

            resultado.style.display = 'block';
            console.log(`üìã Encontrados ${resultados.length} resultados para "${termo}"`);
        }

        function selecionarInscricao(inscricaoId) {
            const insc = offlineManager.obterInscricao(inscricaoId);
            const usuario = offlineManager.obterUsuario(insc.usuario_id);

            inscricaoSelecionadaId = inscricaoId;

            document.getElementById('infoParticipante').innerHTML = `
                <strong>Nome:</strong> ${usuario.nome}<br>
                <strong>Email:</strong> ${usuario.email}<br>
                <strong>Inscri√ß√£o ID:</strong> ${inscricaoId}<br>
                <small class="text-muted">Modo: ${statusOnline ? 'ONLINE' : 'OFFLINE'}</small>
            `;

            document.getElementById('inscricaoSelecionada').style.display = 'block';
        }

        async function confirmarCheckin() {
            console.log('Iniciando processo de check-in');
            
            if (!inscricaoSelecionadaId) {
                mostrarAlerta('Nenhuma inscri√ß√£o selecionada!', 'warning');
                return;
            }

            const insc = offlineManager.obterInscricao(inscricaoSelecionadaId);
            console.log('Dados da inscri√ß√£o:', insc);
            
            try {
                
                const resultado = await offlineManager.marcarPresencaOffline(
                    inscricaoSelecionadaId, 
                    insc.evento_id, 
                    insc.usuario_id
                );
                
                console.log('Resultado da marca√ß√£o:', resultado);
                
                if (resultado.success) {
                    const mensagem = resultado.servidor ? 
                        'Presen√ßa registrada no servidor!' : 
                        'Presen√ßa salva offline';
                    
                    mostrarAlerta(mensagem, 'success');
                    document.getElementById('buscaParticipante').value = '';
                    document.getElementById('resultadosBusca').style.display = 'none';
                    document.getElementById('inscricaoSelecionada').style.display = 'none';
                    inscricaoSelecionadaId = null;
                    
                    setTimeout(() => {
                        document.getElementById('buscaParticipante').focus();
                        carregarEstatisticas();
                    }, 1000);
                } else {
                    mostrarAlerta('Presen√ßa j√° foi registrada para esta inscri√ß√£o!', 'warning');
                }
                
            } catch (error) {
                console.error('Erro capturado:', error);
                mostrarAlerta('Erro ao registrar presen√ßa: ' + error.message, 'danger');
            }
        }

        async function cadastrarUsuario(e) {
            e.preventDefault();

            const dados = {
                nome: document.getElementById('cadastroNome').value,
                email: document.getElementById('cadastroEmail').value,
                senha: 'senha123' 
            };

            try {
                const token = localStorage.getItem('token') || LARAVEL_TOKEN;
                
                const response = await fetch(`${LARAVEL_API}/usuarios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro detalhado:', errorData);
                    
                    if (response.status === 401) {
                        mostrarAlerta('Token expirado. Fa√ßa login novamente!', 'danger');
                        return;
                    }
                    
                    throw new Error(`Erro de valida√ß√£o: ${errorData.message || 'Dados inv√°lidos'}`);
                }

                const data = await response.json();
                
                mostrarAlerta('Usu√°rio cadastrado! Login: email | Senha: senha123', 'success');
                document.getElementById('formCadastro').reset();
                
                setTimeout(() => {
                    carregarDados();
                    document.getElementById('inscricao-tab').click();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao cadastrar: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        async function criarInscricao(e) {
            e.preventDefault();

            const usuarioId = parseInt(document.getElementById('inscricaoUsuario').value);
            const eventoId = parseInt(document.getElementById('inscricaoEvento').value);

            if (!usuarioId || !eventoId) {
                mostrarAlerta('Selecione um participante e um evento!', 'warning');
                return;
            }

            try {
                let token = localStorage.getItem('token');
                if (!token) {
                    mostrarAlerta('Voc√™ precisa estar logado para criar inscri√ß√µes!', 'danger');
                    return;
                }
                console.log('Token de usu√°rio obtido:', token ? 'POSITIVO' : 'NEGATIVO');

                let response = await fetch(`${API_BASE_URL}/inscricoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        usuario_id: usuarioId,
                        evento_id: eventoId,
                        status: 'ativa'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('[INSCRICAO] Erro HTTP:', response.status, errorData);
                    
                    if (response.status === 401) {
                        mostrarAlerta('Token expirado. Fa√ßa login novamente!', 'danger');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    
                    throw new Error(`Erro ${response.status}: ${errorData.message || 'Falha na inscri√ß√£o'}`);
                }

                const data = await response.json();
                console.log('Inscri√ß√£o criada:', data);
                
                offlineManager.dados.inscricoes.push(data.data);
                offlineManager.salvarDadosNoStorage();
                
                mostrarAlerta('Inscri√ß√£o realizada! Agora pode fazer o check-in.', 'success');
                document.getElementById('formInscricao').reset();
                
                setTimeout(async () => {
                    await carregarDados();
                    document.getElementById('checkin-tab').click();
                    carregarEstatisticas();
                }, 1000);
                
            } catch (error) {
                mostrarAlerta('Erro ao criar inscri√ß√£o: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        async function sincronizar() {
            if (!statusOnline) {
                mostrarAlerta('Esta Offiline conecte-se √† internet primeiro.', 'warning');
                return;
            }

            try {
                const resultado = await offlineManager.sincronizarPresencas();
                
                if (resultado.sucesso) {
                    mostrarAlerta(
                        `Sincroniza√ß√£o completa!\n${resultado.sincronizadas} presen√ßa(s) sincronizada(s)\n${resultado.sincronizadas} certificado(s) gerado(s)`,
                        'success'
                    );
                } else {
                    mostrarAlerta(
                        `Sincroniza√ß√£o parcial!\n${resultado.sincronizadas} sucesso, ${resultado.erros} erro(s)`,
                        'warning'
                    );
                }

                await carregarDados();
                
            } catch (error) {
                mostrarAlerta('Erro ao sincronizar: ' + error.message, 'danger');
            }
        }

        async function verificarConexao() {
            await offlineManager.verificarConexao();
        }

        function mostrarAlerta(msg, tipo) {
            const c = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            c.innerHTML = `
                <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show">
                    ${msg.replace(/\n/g, '<br>')}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        console.log('Todas as fun√ß√µes carregadas com sucesso!');
    </script>
</body>

</html>
