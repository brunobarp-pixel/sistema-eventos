<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Atendentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .status-online {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .status-offline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .search-result {
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .pending-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-person-badge"></i> Check-in - Atendentes
            </a>
            <div class="ms-auto">
                <span class="navbar-text text-white me-3" id="statusConexao">
                    <i class="bi bi-wifi-off"></i> Offline
                </span>
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </nav>

    <div id="statusBar" class="status-offline text-white py-2">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <small><i class="bi bi-info-circle"></i> <span id="statusText">Sistema offline - Dados serão
                            sincronizados depois</span></small>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="verificarConexao()">
                        <i class="bi bi-arrow-clockwise"></i> Verificar
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="sincronizar()" id="btnSincronizar">
                        <i class="bi bi-cloud-arrow-up"></i> Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalUsuarios">0</h3>
                        <small class="text-muted">Usuários</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="bi bi-pencil-square text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalInscricoes">0</h3>
                        <small class="text-muted">Inscrições</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill text-info" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalPresencas">0</h3>
                        <small class="text-muted">Presenças</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                        <h3 class="mt-2 pending-badge" id="totalPendentes">0</h3>
                        <small class="text-muted">Pendentes</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checkin-tab" data-bs-toggle="tab" data-bs-target="#checkin">
                    <i class="bi bi-person-check"></i> Fazer Check-in
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro">
                    <i class="bi bi-person-plus"></i> Inscrição Rápida
                </button>
            </li>
        </ul>

        <div class="tab-content">

            <div class="tab-pane fade show active" id="checkin" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-person-check"></i> Registrar Presença</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Buscar Participante</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="buscaParticipante"
                                        placeholder="Digite nome, email ou CPF..." onkeyup="buscarParticipante()">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Evento</label>
                                <select class="form-select" id="eventoCheckin">
                                    <option value="">Carregando eventos...</option>
                                </select>
                            </div>
                        </div>

                        <div id="resultadosBusca" style="display: none;" class="mb-3">
                            <h6>Resultados da busca:</h6>
                            <div id="listaResultados"></div>
                        </div>

                        <div id="inscricaoSelecionada" style="display: none;" class="alert alert-info">
                            <h6><i class="bi bi-person"></i> Participante Selecionado</h6>
                            <p class="mb-0" id="infoParticipante"></p>
                            <button class="btn btn-info mt-2" onclick="confirmarCheckin()">
                                <i class="bi bi-check-circle"></i> Confirmar Presença
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="cadastro" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Inscrição Rápida na Portaria</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Para participantes não cadastrados.
                            <strong>Nome, email e evento</strong> são obrigatórios.
                        </div>

                        <form id="formCadastro">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="cadastroNome" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" class="form-control" id="cadastroEmail" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Evento *</label>
                                <select class="form-select" id="cadastroEvento" required>
                                    <option value="">Selecione um evento</option>
                                </select>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>O que acontecerá:</strong> O usuário será criado com senha padrão (senha123), 
                                inscrito no evento selecionado, e a presença será marcada automaticamente.
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-check"></i> Cadastrar e Marcar Presença
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/perfil.js"></script>
    <script src="js/offline-manager.js"></script>
    <script>
        const API_BASE_URL = 'http://177.44.248.118:8000/api'; // Laravel API principal
        const OFFLINE_API_URL = 'http://177.44.248.118:8081/api'; // Novo Backend Offline
        const LARAVEL_API = 'http://177.44.248.118:8000/api'; // Alias para compatibilidade
        const OFFLINE_API = 'http://177.44.248.118:8081/api'; // Novo endpoint offline
        const LARAVEL_TOKEN = '70|VaI5IynnhSWh5OcaRzbL4mZq4WnXSjPDf003cqSE65c407fe';
        
        
        //  globais
        let offlineManager;
        let statusOnline = false;
        let listaUsuarios = [];
        let listaInscricoes = [];
        let inscricaoAtualId = null;
        let inscricaoSelecionadaId = null; // Variável para armazenar inscrição selecionada
        let todosUsuarios = []; // Para compatibilidade com estatísticas
        let todasInscricoes = []; // Para compatibilidade com estatísticas

        // Funções globais
        async function cadastrarUsuario(e) {
            e.preventDefault();

            const nome = document.getElementById('cadastroNome').value;
            const email = document.getElementById('cadastroEmail').value;
            const eventoSelect = document.getElementById('cadastroEvento');
            const eventoSelecionado = eventoSelect.value;

            if (!nome || !email || !eventoSelecionado) {
                mostrarAlerta('Preencha todos os campos obrigatórios e selecione um evento!', 'warning');
                return;
            }

            try {
                const cadastrosCompletos = JSON.parse(localStorage.getItem('cadastros_completos') || '[]');
                
                const novoCadastroCompleto = {
                    id: `temp_${Date.now()}`,
                    usuario: {
                        nome: nome.trim(),
                        email: email.trim(),
                        senha: 'senha123'
                    },
                    evento_id: eventoSelecionado,
                    timestamp: new Date().toISOString(),
                    sincronizado: false
                };

                cadastrosCompletos.push(novoCadastroCompleto);
                localStorage.setItem('cadastros_completos', JSON.stringify(cadastrosCompletos));

                atualizarContadorPendentes();

                mostrarAlerta(`Cadastro salvo! O usuário será criado, inscrito, terá presença marcada e receberá certificado por email.`, 'success');
                document.getElementById('formCadastro').reset();

            } catch (error) {
                mostrarAlerta('Erro ao salvar inscrição rápida: ' + error.message, 'danger');
                console.error('Erro:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('token');
            const usuario = localStorage.getItem('usuario');
            
            if (!token || !usuario) {
                mostrarAlerta('Você precisa estar logado para acessar esta página!', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }
            
            
            offlineManager = new OfflineManager({
                apiBase: API_BASE_URL,
                offlineApi: OFFLINE_API_URL,
                timeout: 5000,
                onStatusChange: (online) => {
                    statusOnline = online;
                    atualizarStatusBar();
                },
                onDataLoaded: (dados) => {
                    console.log('Dados carregados para localStorage:', {
                        eventos: dados.eventos?.length || 0,
                        usuarios: dados.usuarios?.length || 0,
                        inscricoes: dados.inscricoes?.length || 0,
                        presencas: dados.presencas?.length || 0
                    });
                    
                    listaUsuarios = dados.usuarios || [];
                    listaInscricoes = dados.inscricoes || [];
                    atualizarUIs();
                },
                onPresencaRegistrada: (presenca) => {
                    carregarEstatisticas();
                },
                onSyncStart: () => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sincronizando...';
                },
                onSyncEnd: (resultado) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(
                        ` ${resultado.totalSincronizados} item(ns) sincronizado(s)!`,
                        resultado.erros.length > 0 ? 'warning' : 'success'
                    );
                },
                onSyncError: (erro) => {
                    const btn = document.getElementById('btnSincronizar');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
                    mostrarAlerta(`Erro na sincronização: ${erro.message}`, 'danger');
                }
            });

            
            const inicializacao = await offlineManager.inicializar();
            if (inicializacao) {
            } else {
                console.warn('Sistema inicializado com limitações');
                mostrarAlerta('Sistema funcionando em modo limitado - algumas funcionalidades podem não estar disponíveis', 'warning');
            }
            
            await offlineManager.carregarTodosDados();
            
            const formCadastro = document.getElementById('formCadastro');
            
            if (formCadastro && typeof cadastrarUsuario === 'function') {
                formCadastro.addEventListener('submit', cadastrarUsuario);
            } else {
                console.error('Erro: formCadastro ou cadastrarUsuario não encontrado');
            }

            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
                btn.addEventListener('shown.bs.tab', () => {
                    carregarEstatisticas();
                    atualizarSelectEventos();
                });
            });

            setInterval(() => {
                offlineManager.verificarConexao();
            }, 5000);
            
            await carregarEstatisticas();
        });

        function atualizarContadorPendentes() {
            const inscricoesRapidas = JSON.parse(localStorage.getItem('inscricoes_rapidas') || '[]');
            const presencasOffline = JSON.parse(localStorage.getItem('presencas_offline') || '[]');
            const cadastrosCompletos = JSON.parse(localStorage.getItem('cadastros_completos') || '[]');
            
            const pendentesInscricoes = inscricoesRapidas.filter(i => !i.sincronizado).length;
            const pendentesPresencas = presencasOffline.filter(p => !p.sincronizado).length;
            const pendentesCadastros = cadastrosCompletos.filter(c => !c.sincronizado).length;
            
            const total = pendentesInscricoes + pendentesPresencas + pendentesCadastros;
            document.getElementById('totalPendentes').textContent = total;
            
            console.log(`Pendentes: ${pendentesInscricoes} inscrições + ${pendentesPresencas} presenças + ${pendentesCadastros} cadastros completos = ${total} total`);
        }

        function atualizarStatusBar() {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const statusConexao = document.getElementById('statusConexao');

            if (statusOnline) {
                statusBar.className = 'status-online text-white py-2';
                statusText.innerHTML = 'Sistema ONLINE - Dados em tempo real';
                statusConexao.innerHTML = '<i class="bi bi-wifi"></i> Online';
            } else {
                statusBar.className = 'status-offline text-white py-2';
                statusText.innerHTML = '○ Sistema OFFLINE - Dados em cache';
                statusConexao.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }

        function atualizarUIs() {
            atualizarSelectEventos();
            atualizarContadorPendentes();
            carregarEstatisticas();
        }

        async function carregarDados() {
            await offlineManager.carregarTodosDados();
        }

        async function carregarEstatisticas() {
            try {
                if (!offlineManager) {
                    console.warn('OfflineManager ainda não existe, aguardando...');
                    setTimeout(carregarEstatisticas, 1000);
                    return;
                }
                
                if (!offlineManager.dados) {
                    console.warn('Dados ainda não carregados, aguardando...');
                    setTimeout(carregarEstatisticas, 1000);
                    return;
                }
                
                if (statusOnline) {
                    try {
                        const resp = await fetch(`${OFFLINE_API}/offline/status`, {
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (resp.ok) {
                            const data = await resp.json();
                        }
                    } catch (error) {
                        console.warn('Erro ao consultar backend-offline:', error);
                    }
                }
                
                const usuarios = offlineManager.dados.usuarios || [];
                const inscricoes = offlineManager.dados.inscricoes || [];
                const presencas = offlineManager.dados.presencas || [];
                
                const presencasOffline = JSON.parse(localStorage.getItem('presencas_offline') || '[]');
                const totalPendentes = presencasOffline.filter(p => !p.sincronizado).length;
                
                
                document.getElementById('totalUsuarios').textContent = usuarios.length || 0;
                document.getElementById('totalInscricoes').textContent = inscricoes.length || 0;
                document.getElementById('totalPresencas').textContent = presencas.length || 0;
                document.getElementById('totalPendentes').textContent = totalPendentes || 0;
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                document.getElementById('totalUsuarios').textContent = 0;
                document.getElementById('totalInscricoes').textContent = 0;
                document.getElementById('totalPresencas').textContent = 0;
                document.getElementById('totalPendentes').textContent = 0;
            }
        }

        function atualizarSelectEventos() {
            const selects = [
                document.getElementById('eventoCheckin'),
                document.getElementById('cadastroEvento')
            ];

            selects.forEach(s => {
                if (s) {
                    s.innerHTML = '<option value="">Selecione um evento</option>';
                    if (offlineManager && offlineManager.dados && offlineManager.dados.eventos) {
                        offlineManager.dados.eventos.forEach(e => {
                            const nomeEvento = e.nome || e.titulo || e.name || 'Evento sem nome';
                            s.innerHTML += `<option value="${e.id}">${nomeEvento}</option>`;
                        });
                    }
                }
            });
            
            const eventoCheckin = document.getElementById('eventoCheckin');
            if (eventoCheckin) {
                eventoCheckin.removeEventListener('change', mostrarInscricoesDoEvento);
                eventoCheckin.addEventListener('change', mostrarInscricoesDoEvento);
            }
        }
        
        function mostrarInscricoesDoEvento() {
            const eventoId = document.getElementById('eventoCheckin').value;
            const resultadosBusca = document.getElementById('resultadosBusca');
            const listaResultados = document.getElementById('listaResultados');
            
            if (!eventoId) {
                resultadosBusca.style.display = 'none';
                return;
            }
            
            
            if (!offlineManager || !offlineManager.dados) {
                listaResultados.innerHTML = '<div class="alert alert-warning">Dados ainda carregando...</div>';
                resultadosBusca.style.display = 'block';
                return;
            }
            
            const inscricoesDoEvento = offlineManager.obterInscricoesPorEvento(eventoId, true);
            
            if (inscricoesDoEvento.length === 0) {
                listaResultados.innerHTML = '<div class="alert alert-info">Nenhum participante inscrito neste evento</div>';
                resultadosBusca.style.display = 'block';
                return;
            }
            
            listaResultados.innerHTML = '';
            inscricoesDoEvento.forEach(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                const temPresenca = offlineManager.temPresenca(insc.id);
                
                listaResultados.innerHTML += `
                <div class="card search-result mb-2 ${temPresenca ? 'bg-light' : ''}" 
                     onclick="${temPresenca ? '' : `selecionarInscricao(${insc.id})`}"
                     style="${temPresenca ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;'}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${usuario.nome}</strong> - ${usuario.email}<br>
                                <small class="text-muted">
                                    ${usuario.cpf ? 'CPF: ' + usuario.cpf : ''}
                                </small>
                            </div>
                            ${temPresenca ? '<span class="badge bg-success">✓ Presença registrada</span>' : '<span class="badge bg-primary">Clique para marcar presença</span>'}
                        </div>
                    </div>
                </div>
            `;
            });
            
            resultadosBusca.style.display = 'block';
        }
        function buscarParticipante() {
            const termo = document.getElementById('buscaParticipante').value.toLowerCase().trim();
            const resultado = document.getElementById('resultadosBusca');
            const lista = document.getElementById('listaResultados');
            const eventoId = document.getElementById('eventoCheckin').value;

            if (termo.length < 2) {
                if (eventoId) {
                    mostrarInscricoesDoEvento();
                } else {
                    resultado.style.display = 'none';
                }
                return;
            }

            if (!eventoId) {
                lista.innerHTML = '<div class="alert alert-warning">Selecione um evento primeiro</div>';
                resultado.style.display = 'block';
                return;
            }


            const inscricoesDoEvento = offlineManager.obterInscricoesPorEvento(eventoId, true);

            const resultados = inscricoesDoEvento.filter(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                if (!usuario) return false;

                const nome = (usuario.nome || '').toLowerCase();
                const email = (usuario.email || '').toLowerCase();
                const cpf = (usuario.cpf || '').toLowerCase().replace(/[^\d]/g, '');
                const termoLimpo = termo.replace(/[^\d]/g, '');

                return nome.includes(termo) ||
                    email.includes(termo) ||
                    (cpf && termoLimpo && cpf.includes(termoLimpo));
            });

            if (resultados.length === 0) {
                lista.innerHTML = '<div class="alert alert-warning">Nenhum participante encontrado neste evento com este termo</div>';
                resultado.style.display = 'block';
                return;
            }

            lista.innerHTML = '';
            resultados.forEach(insc => {
                const usuario = offlineManager.obterUsuario(insc.usuario_id);
                const temPresenca = offlineManager.temPresenca(insc.id);

                lista.innerHTML += `
            <div class="card search-result mb-2 ${temPresenca ? 'bg-light' : ''}" 
                 onclick="${temPresenca ? '' : `selecionarInscricao(${insc.id})`}"
                 style="${temPresenca ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;'}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${usuario.nome}</strong> - ${usuario.email}<br>
                            <small class="text-muted">
                                ${usuario.cpf ? 'CPF: ' + usuario.cpf : ''}
                            </small>
                        </div>
                        ${temPresenca ? '<span class="badge bg-success">✓ Presença registrada</span>' : '<span class="badge bg-primary">Clique para marcar presença</span>'}
                    </div>
                </div>
            </div>
        `;
            });

            resultado.style.display = 'block';
        }

        function selecionarInscricao(inscricaoId) {
            const insc = offlineManager.obterInscricao(inscricaoId);
            const usuario = offlineManager.obterUsuario(insc.usuario_id);

            inscricaoSelecionadaId = inscricaoId;

            document.getElementById('infoParticipante').innerHTML = `
                <strong>Nome:</strong> ${usuario.nome}<br>
                <strong>Email:</strong> ${usuario.email}<br>
                <strong>Inscrição ID:</strong> ${inscricaoId}<br>
                <small class="text-muted">Modo: ${statusOnline ? 'ONLINE' : 'OFFLINE'}</small>
            `;

            document.getElementById('inscricaoSelecionada').style.display = 'block';
        }

        async function confirmarCheckin() {
            
            if (!inscricaoSelecionadaId) {
                mostrarAlerta('Nenhuma inscrição selecionada!', 'warning');
                return;
            }

            const insc = offlineManager.obterInscricao(inscricaoSelecionadaId);
            
            try {
                
                const resultado = await offlineManager.marcarPresencaOffline(
                    inscricaoSelecionadaId, 
                    insc.evento_id, 
                    insc.usuario_id
                );
                                
                if (resultado.success) {
                    const mensagem = resultado.servidor ? 
                        'Presença registrada no servidor!' : 
                        'Presença salva offline';
                    
                    mostrarAlerta(mensagem, 'success');
                    document.getElementById('buscaParticipante').value = '';
                    document.getElementById('resultadosBusca').style.display = 'none';
                    document.getElementById('inscricaoSelecionada').style.display = 'none';
                    inscricaoSelecionadaId = null;
                    
                    setTimeout(() => {
                        document.getElementById('buscaParticipante').focus();
                        carregarEstatisticas();
                    }, 1000);
                } else {
                    mostrarAlerta('Presença já foi registrada para esta inscrição!', 'warning');
                }
                
            } catch (error) {
                console.error('Erro capturado:', error);
                mostrarAlerta('Erro ao registrar presença: ' + error.message, 'danger');
            }
        }

        async function sincronizar() {
            if (!statusOnline) {
                mostrarAlerta('Sistema offline! Conecte-se à internet primeiro.', 'warning');
                return;
            }

            try {
                const btnSincronizar = document.getElementById('btnSincronizar');
                btnSincronizar.disabled = true;
                btnSincronizar.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sincronizando...';

                await sincronizarCadastrosCompletos();

                await sincronizarInscricoesRapidas();

                const resultado = await offlineManager.sincronizarPresencas();
                
                if (resultado.sucesso) {
                    mostrarAlerta(
                        `Sincronização completa!\n${resultado.sincronizadas} presença(s) sincronizada(s)`,
                        'success'
                    );
                    
                    limparDadosSincronizados();
                } else {
                    mostrarAlerta(
                        `Sincronização parcial!\n${resultado.sincronizadas} sucesso, ${resultado.erros?.length || 0} erro(s)`,
                        'warning'
                    );
                }

                await carregarEstatisticas();
                atualizarContadorPendentes();
                
            } catch (error) {
                console.error('Erro ao sincronizar:', error);
                mostrarAlerta('Erro ao sincronizar: ' + error.message, 'danger');
            } finally {
                const btnSincronizar = document.getElementById('btnSincronizar');
                btnSincronizar.disabled = false;
                btnSincronizar.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sincronizar';
            }
        }

        function limparDadosSincronizados() {
            try {
                const cadastrosCompletos = JSON.parse(localStorage.getItem('cadastros_completos') || '[]');
                const cadastrosNaoSincronizados = cadastrosCompletos.filter(c => !c.sincronizado);
                if (cadastrosNaoSincronizados.length === 0) {
                    localStorage.removeItem('cadastros_completos');
                    console.log('Cadastros completos limpos do localStorage');
                } else {
                    localStorage.setItem('cadastros_completos', JSON.stringify(cadastrosNaoSincronizados));
                    console.log(`${cadastrosCompletos.length - cadastrosNaoSincronizados.length} cadastros sincronizados removidos`);
                }

                const inscricoesRapidas = JSON.parse(localStorage.getItem('inscricoes_rapidas') || '[]');
                const inscricoesNaoSincronizadas = inscricoesRapidas.filter(i => !i.sincronizado);
                if (inscricoesNaoSincronizadas.length === 0) {
                    localStorage.removeItem('inscricoes_rapidas');
                    console.log('Inscrições rápidas limpas do localStorage');
                } else {
                    localStorage.setItem('inscricoes_rapidas', JSON.stringify(inscricoesNaoSincronizadas));
                    console.log(`${inscricoesRapidas.length - inscricoesNaoSincronizadas.length} inscrições sincronizadas removidas`);
                }

                const presencasOffline = JSON.parse(localStorage.getItem('presencas_offline') || '[]');
                const presencasNaoSincronizadas = presencasOffline.filter(p => !p.sincronizado);
                if (presencasNaoSincronizadas.length === 0) {
                    localStorage.removeItem('presencas_offline');
                    console.log('Presenças limpas do localStorage');
                } else {
                    localStorage.setItem('presencas_offline', JSON.stringify(presencasNaoSincronizadas));
                    console.log(`${presencasOffline.length - presencasNaoSincronizadas.length} presenças sincronizadas removidas`);
                }

                console.log('Limpeza de dados sincronizados concluída');
            } catch (error) {
                console.error('Erro ao limpar dados sincronizados:', error);
            }
        }

        async function sincronizarCadastrosCompletos() {
            const cadastrosCompletos = JSON.parse(localStorage.getItem('cadastros_completos') || '[]');
            const pendentes = cadastrosCompletos.filter(c => !c.sincronizado);
            
            if (pendentes.length === 0) {
                console.log('Nenhum cadastro completo pendente');
                return;
            }

            console.log(`Sincronizando ${pendentes.length} cadastros completos...`);
            const token = localStorage.getItem('token');
            console.log(`Token para sincronização: ${token ? token.substring(0, 20) + '...' : 'NÃO ENCONTRADO'}`);

            for (const cadastro of pendentes) {
                try {
                    console.log(`Processando cadastro:`, cadastro);
                    
                    console.log(`Criando usuário: ${cadastro.usuario.nome} (${cadastro.usuario.email})`);
                    const usuario = await criarUsuarioCompleto(cadastro.usuario);
                    console.log(`Usuário criado com ID: ${usuario.id}`);
                    
                    console.log(`Processando evento ${cadastro.evento_id}...`);
                    await processarEventoCompleto(usuario.id, cadastro.evento_id);
                    
                    cadastro.sincronizado = true;
                    console.log(`Cadastro completo sincronizado com sucesso!`);
                    
                } catch (error) {
                    console.error(`Erro ao sincronizar cadastro completo:`, error);
                    console.error(`Dados do cadastro que falhou:`, cadastro);
                }
            }
            
            localStorage.setItem('cadastros_completos', JSON.stringify(cadastrosCompletos));
            console.log('Processo de sincronização de cadastros completos finalizado');
        }

        async function processarEventoCompleto(usuarioId, eventoId) {
            const token = localStorage.getItem('token');
            
            console.log(`Iniciando processamento completo para usuário ${usuarioId} no evento ${eventoId}`);
            
            try {
                console.log(`Criando inscrição para usuário ${usuarioId} no evento ${eventoId}...`);
                console.log(`URL: ${API_BASE_URL}/inscricoes`);
                console.log(`Token: ${token ? 'Presente' : 'Ausente'}`);
                
                const inscricaoPayload = {
                    usuario_id: usuarioId,
                    evento_id: eventoId,
                    status: 'confirmada'
                };
                console.log(`Payload da inscrição:`, inscricaoPayload);
                
                const inscricaoResponse = await fetch(`${API_BASE_URL}/inscricoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(inscricaoPayload)
                });

                console.log(`Status da resposta de inscrição: ${inscricaoResponse.status} ${inscricaoResponse.statusText}`);

                if (!inscricaoResponse.ok) {
                    const errorData = await inscricaoResponse.json().catch(() => ({}));
                    console.error(`Erro ao criar inscrição:`, errorData);
                    console.error(`Detalhes do erro:`);
                    console.error(`   - Status: ${inscricaoResponse.status}`);
                    console.error(`   - Status Text: ${inscricaoResponse.statusText}`);
                    console.error(`   - Error Data:`, errorData);
                    
                    if (errorData.errors) {
                        console.error(`   - Erros de validação:`, errorData.errors);
                        Object.keys(errorData.errors).forEach(campo => {
                            console.error(`     * ${campo}: ${errorData.errors[campo].join(', ')}`);
                        });
                    }
                    
                    throw new Error(`Erro ao criar inscrição: ${inscricaoResponse.status} - ${errorData.message || inscricaoResponse.statusText}`);
                }

                const inscricaoData = await inscricaoResponse.json();
                const inscricaoId = inscricaoData.data.id;
                console.log(`Inscrição criada com sucesso!`);
                console.log(`   - ID da inscrição: ${inscricaoId}`);
                console.log(`   - Dados completos:`, inscricaoData);

                console.log(`Marcando presença para inscrição ${inscricaoId}...`);
                console.log(`URL: ${API_BASE_URL}/presencas`);
                
                const presencaPayload = {
                    inscricao_id: inscricaoId
                };
                console.log(`Payload da presença:`, presencaPayload);
                
                const presencaResponse = await fetch(`${API_BASE_URL}/presencas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(presencaPayload)
                });

                console.log(`Status da resposta de presença: ${presencaResponse.status} ${presencaResponse.statusText}`);

                if (!presencaResponse.ok) {
                    const errorData = await presencaResponse.json().catch(() => ({}));
                    console.error(`Erro ao marcar presença:`, errorData);
                    console.error(`   - Status: ${presencaResponse.status}`);
                    console.error(`   - Status Text: ${presencaResponse.statusText}`);
                    console.error(`   - Error Data:`, errorData);
                    
                    if (errorData.errors) {
                        console.error(`   - Erros de validação:`, errorData.errors);
                        Object.keys(errorData.errors).forEach(campo => {
                            console.error(`     * ${campo}: ${errorData.errors[campo].join(', ')}`);
                        });
                    }
                    
                    throw new Error(`Erro ao marcar presença: ${presencaResponse.status} - ${errorData.message || presencaResponse.statusText}`);
                }

                const presencaData = await presencaResponse.json();
                console.log(`Presença marcada com sucesso!`);
                console.log(`   - Dados da presença:`, presencaData);

                console.log(`Gerando certificado...`);
                const certificadoResponse = await fetch(`${API_BASE_URL}/certificados`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        usuario_id: usuarioId,
                        evento_id: eventoId
                    })
                });

                if (!certificadoResponse.ok) {
                    const errorData = await certificadoResponse.json().catch(() => ({}));
                    console.warn(`Aviso - Erro ao gerar certificado:`, errorData);
                } else {
                    const certificadoData = await certificadoResponse.json();
                    console.log(`Certificado gerado e enviado:`, certificadoData);
                }

                console.log(`Processamento completo finalizado para usuário ${usuarioId} no evento ${eventoId}`);

            } catch (error) {
                console.error(`Erro ao processar evento completo:`, error);
                throw error;
            }
        }

        async function sincronizarInscricoesRapidas() {
            const inscricoesRapidas = JSON.parse(localStorage.getItem('inscricoes_rapidas') || '[]');
            const pendentes = inscricoesRapidas.filter(i => !i.sincronizado);
            
            if (pendentes.length === 0) {
                console.log('Nenhuma inscrição rápida pendente');
                return;
            }

            console.log(`Sincronizando ${pendentes.length} inscrições rápidas...`);

            for (const inscricao of pendentes) {
                try {
                    const usuario = await criarUsuarioCompleto(inscricao.usuario);
                    
                    for (const eventoId of inscricao.eventos) {
                        await processarInscricaoEvento(usuario.id, eventoId);
                    }
                    
                    inscricao.sincronizado = true;
                    
                } catch (error) {
                    console.error(`Erro ao sincronizar inscrição rápida:`, error);
                }
            }
            
            localStorage.setItem('inscricoes_rapidas', JSON.stringify(inscricoesRapidas));
        }

        async function criarUsuarioCompleto(dadosUsuario) {
            const token = localStorage.getItem('token');
            
            console.log(`Criando usuário:`, dadosUsuario);
            
            const gerarCPFUnico = () => {
                const numeros = Array.from({length: 11}, () => Math.floor(Math.random() * 10)).join('');
                return `${numeros.substring(0, 3)}.${numeros.substring(3, 6)}.${numeros.substring(6, 9)}-${numeros.substring(9)}`;
            };
            
            const gerarTelefoneUnico = () => {
                const area = Math.floor(Math.random() * 90) + 10;
                const numero = Math.floor(Math.random() * 900000000) + 100000000;
                return `(${area}) ${Math.floor(numero / 10000)}-${numero % 10000}`;
            };
            
            const usuarioCompleto = {
                nome: dadosUsuario.nome,
                email: dadosUsuario.email,
                senha: dadosUsuario.senha || 'senha123',
                cpf: dadosUsuario.cpf || gerarCPFUnico(),
                telefone: dadosUsuario.telefone || gerarTelefoneUnico()
            };
            
            console.log(`Dados do usuário completos:`, usuarioCompleto);
            
            const response = await fetch(`${API_BASE_URL}/usuarios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(usuarioCompleto)
            });

            console.log(`Status da resposta de criação de usuário: ${response.status} ${response.statusText}`);

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                console.error(`Erro ao criar usuário:`, error);
                
                if (error.errors) {
                    console.error(`Erros de validação`, error.errors);
                    Object.keys(error.errors).forEach(campo => {
                        console.error(`   - ${campo}: ${error.errors[campo].join(', ')}`);
                    });
                }
                
                throw new Error(`Erro ao criar usuário: ${response.status} - ${error.message || response.statusText}`);
            }

            const data = await response.json();
            console.log(`usuário criado com sucesso:`, data.data);
            return data.data;
        }

        async function processarInscricaoEvento(usuarioId, eventoId) {
            const token = localStorage.getItem('token');
            
            try {
                const inscricaoResponse = await fetch(`${API_BASE_URL}/inscricoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        usuario_id: usuarioId,
                        evento_id: eventoId,
                        status: 'confirmada'
                    })
                });

                if (!inscricaoResponse.ok) {
                    throw new Error(`Erro ao criar inscrição: ${inscricaoResponse.statusText}`);
                }

                const inscricaoData = await inscricaoResponse.json();
                const inscricaoId = inscricaoData.data.id;

                const presencaResponse = await fetch(`${API_BASE_URL}/presencas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        inscricao_id: inscricaoId,
                        evento_id: eventoId,
                        usuario_id: usuarioId,
                        data_checkin: new Date().toISOString()
                    })
                });

                if (!presencaResponse.ok) {
                    console.warn(`Erro ao marcar presença, mas inscrição foi criada`);
                }

                try {
                    await fetch(`http://177.44.248.118:5000/gerar-certificado/${inscricaoId}`, {
                        method: 'POST'
                    });
                } catch (certError) {
                    console.warn('Erro ao gerar certificado:', certError);
                }

            } catch (error) {
                console.error(`Erro ao processar evento ${eventoId}:`, error);
                throw error;
            }
        }

        async function verificarConexao() {
            await offlineManager.verificarConexao();
        }

        function mostrarAlerta(msg, tipo) {
            const c = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            c.innerHTML = `
                <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show">
                    ${msg.replace(/\n/g, '<br>')}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

    </script>
</body>

</html>
