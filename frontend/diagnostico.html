<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico - Sistema de Eventos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 13px;
        }
        .status-ok { color: #28a745; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        pre { background: #fff; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1>üîç Diagn√≥stico do Sistema</h1>
        <p class="text-muted">Verificando configura√ß√µes e dados...</p>

        <div id="results"></div>

        <button class="btn btn-primary" onclick="executarDiagnostico()">
            üîÑ Executar Diagn√≥stico Novamente
        </button>
    </div>

    <script>
        const API_URL = 'http://177.44.248.118:8000/api';
        let usuario = null;

        async function executarDiagnostico() {
            const container = document.getElementById('results');
            container.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';

            let html = '';

            // ========== TESTE 1: Verificar Usu√°rio Logado ==========
            html += '<div class="debug-box">';
            html += '<h5>1Ô∏è‚É£ Verificando Usu√°rio Logado</h5>';
            
            const usuarioData = localStorage.getItem('usuario');
            if (usuarioData) {
                usuario = JSON.parse(usuarioData);
                html += `<span class="status-ok">‚úÖ Usu√°rio logado:</span> ${usuario.nome} (ID: ${usuario.id})<br>`;
                html += `<span class="status-ok">‚úÖ Email:</span> ${usuario.email}`;
            } else {
                html += '<span class="status-error">‚ùå Nenhum usu√°rio logado!</span><br>';
                html += '<a href="login.html">üëâ Fa√ßa login aqui</a>';
                container.innerHTML = html;
                return;
            }
            html += '</div>';

            // ========== TESTE 2: Buscar Inscri√ß√µes do Usu√°rio ==========
            html += '<div class="debug-box">';
            html += '<h5>2Ô∏è‚É£ Buscando Inscri√ß√µes do Usu√°rio</h5>';
            
            try {
                const response = await fetch(`${API_URL}/usuarios/${usuario.id}/inscricoes`);
                const data = await response.json();

                if (data.success && data.data) {
                    html += `<span class="status-ok">‚úÖ Total de inscri√ß√µes:</span> ${data.data.length}<br><br>`;
                    
                    html += '<strong>üìã Detalhes das inscri√ß√µes:</strong><br>';
                    data.data.forEach((insc, index) => {
                        html += `<br><strong>Inscri√ß√£o ${index + 1}:</strong><br>`;
                        html += `‚Ä¢ ID: ${insc.id}<br>`;
                        html += `‚Ä¢ Evento: ${insc.evento?.titulo || 'N/A'}<br>`;
                        html += `‚Ä¢ Status: ${insc.status}<br>`;
                        html += `‚Ä¢ Possui presen√ßa: ${insc.possui_presenca ? '‚úÖ SIM' : '‚ùå N√ÉO'}<br>`;
                        html += `‚Ä¢ Data inscri√ß√£o: ${insc.data_inscricao}<br>`;
                    });

                    // Contar com presen√ßa
                    const comPresenca = data.data.filter(i => i.possui_presenca).length;
                    const semPresenca = data.data.length - comPresenca;

                    html += `<br><strong>üìä Resumo:</strong><br>`;
                    html += `‚Ä¢ Com presen√ßa: <span class="status-ok">${comPresenca}</span><br>`;
                    html += `‚Ä¢ Sem presen√ßa: <span class="status-warning">${semPresenca}</span>`;

                    if (comPresenca === 0) {
                        html += '<br><br><span class="status-warning">‚ö†Ô∏è ATEN√á√ÉO: Nenhuma inscri√ß√£o tem presen√ßa registrada!</span><br>';
                        html += 'Para emitir certificado, √© necess√°rio fazer check-in no evento.';
                    }
                } else {
                    html += '<span class="status-error">‚ùå Nenhuma inscri√ß√£o encontrada</span>';
                }
            } catch (error) {
                html += `<span class="status-error">‚ùå Erro ao buscar inscri√ß√µes: ${error.message}</span>`;
            }
            html += '</div>';

            // ========== TESTE 3: Buscar Certificados Emitidos ==========
            html += '<div class="debug-box">';
            html += '<h5>3Ô∏è‚É£ Verificando Certificados Emitidos</h5>';
            
            try {
                const response = await fetch(`${API_URL}/certificados/usuario/${usuario.id}`);
                const data = await response.json();

                if (data.success && data.data) {
                    html += `<span class="status-ok">‚úÖ Total de certificados:</span> ${data.data.length}<br><br>`;
                    
                    if (data.data.length > 0) {
                        html += '<strong>üéì Certificados emitidos:</strong><br>';
                        data.data.forEach((cert, index) => {
                            html += `<br><strong>Certificado ${index + 1}:</strong><br>`;
                            html += `‚Ä¢ Evento: ${cert.evento?.titulo || 'N/A'}<br>`;
                            html += `‚Ä¢ C√≥digo: ${cert.codigo_validacao}<br>`;
                            html += `‚Ä¢ Data emiss√£o: ${cert.data_emissao}`;
                        });
                    }
                } else {
                    html += '<span class="status-warning">‚ö†Ô∏è Nenhum certificado emitido ainda</span>';
                }
            } catch (error) {
                html += `<span class="status-error">‚ùå Erro ao buscar certificados: ${error.message}</span>`;
            }
            html += '</div>';

            // ========== TESTE 4: Verificar Estrutura do Banco ==========
            html += '<div class="debug-box">';
            html += '<h5>4Ô∏è‚É£ Verificando Endpoints da API</h5>';
            
            const endpoints = [
                { url: '/eventos', nome: 'Listar Eventos' },
                { url: `/usuarios/${usuario.id}/inscricoes`, nome: 'Inscri√ß√µes do Usu√°rio' },
                { url: `/certificados/usuario/${usuario.id}`, nome: 'Certificados do Usu√°rio' }
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_URL}${endpoint.url}`);
                    if (response.ok) {
                        html += `<span class="status-ok">‚úÖ</span> ${endpoint.nome} (${endpoint.url})<br>`;
                    } else {
                        html += `<span class="status-error">‚ùå</span> ${endpoint.nome} - Status ${response.status}<br>`;
                    }
                } catch (error) {
                    html += `<span class="status-error">‚ùå</span> ${endpoint.nome} - Erro: ${error.message}<br>`;
                }
            }
            html += '</div>';

            // ========== TESTE 5: Sugest√µes ==========
            html += '<div class="debug-box">';
            html += '<h5>5Ô∏è‚É£ Sugest√µes</h5>';
            html += '<ul>';
            html += '<li>‚úÖ Para emitir certificado, √© necess√°rio: estar inscrito + ter presen√ßa registrada</li>';
            html += '<li>‚úÖ Certificados s√≥ aparecem para eventos com presen√ßa confirmada</li>';
            html += '<li>‚úÖ O check-in deve ser feito na p√°gina "offline.html" pelos atendentes</li>';
            html += '<li>‚úÖ Ap√≥s o check-in, o evento aparecer√° na lista para emiss√£o de certificado</li>';
            html += '</ul>';
            html += '</div>';

            container.innerHTML = html;
        }

        // Executar ao carregar
        window.addEventListener('DOMContentLoaded', executarDiagnostico);
    </script>
</body>
</html>