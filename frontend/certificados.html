<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Certificados - Sistema de Eventos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .certificate-card {
            transition: transform 0.3s;
            border-left: 4px solid #667eea;
        }
        .certificate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .validation-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-calendar-event"></i> Sistema de Eventos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="eventos.html">Eventos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inscricoes.html">Minhas Inscri√ß√µes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="certificados.html">Certificados</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Sair
                        </a>
                    </li>
                </ul>
                <span class="navbar-text ms-3" id="nomeUsuario"></span>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-primary text-white py-5">
        <div class="container">
            <h1 class="display-4"><i class="bi bi-award"></i> Meus Certificados</h1>
            <p class="lead">Visualize e baixe seus certificados de participa√ß√£o</p>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="container my-5">
        <!-- Abas -->
        <ul class="nav nav-tabs mb-4" id="certificadosTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="meus-tab" data-bs-toggle="tab" data-bs-target="#meus" type="button">
                    <i class="bi bi-collection"></i> Meus Certificados
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="emitir-tab" data-bs-toggle="tab" data-bs-target="#emitir" type="button">
                    <i class="bi bi-plus-circle"></i> Emitir Novo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="validar-tab" data-bs-toggle="tab" data-bs-target="#validar" type="button">
                    <i class="bi bi-shield-check"></i> Validar Certificado
                </button>
            </li>
        </ul>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Conte√∫do das Abas -->
        <div class="tab-content" id="certificadosTabContent">
            
            <!-- Aba: Meus Certificados -->
            <div class="tab-pane fade show active" id="meus" role="tabpanel">
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Carregando certificados...</p>
                </div>

                <div id="certificadosContainer" style="display: none;">
                    <!-- Certificados ser√£o inseridos aqui -->
                </div>
            </div>

            <!-- Aba: Emitir Novo Certificado -->
            <div class="tab-pane fade" id="emitir" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-award"></i> Emitir Novo Certificado</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Selecione um evento no qual voc√™ participou (com presen√ßa registrada) para emitir seu certificado.
                        </p>

                        <div id="loadingEventos" class="text-center py-3" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2">Carregando eventos...</span>
                        </div>

                        <div class="mb-3">
                            <label for="eventoSelectEmitir" class="form-label">Evento</label>
                            <select class="form-select" id="eventoSelectEmitir">
                                <option value="">Selecione um evento</option>
                            </select>
                        </div>

                        <div id="eventoInfoEmitir" style="display: none;" class="alert alert-info">
                            <!-- Info do evento -->
                        </div>

                        <button class="btn btn-success" onclick="emitirCertificado()">
                            <i class="bi bi-award"></i> Emitir Certificado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aba: Validar Certificado -->
            <div class="tab-pane fade" id="validar" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-shield-check"></i> Validar Certificado</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Digite o c√≥digo de valida√ß√£o impresso no certificado para verificar sua autenticidade.
                        </p>

                        <div class="mb-3">
                            <label for="codigoValidacao" class="form-label">C√≥digo de Valida√ß√£o</label>
                            <input type="text" class="form-control" id="codigoValidacao" 
                                   placeholder="Ex: a1b2c3d4e5f6g7h8..." maxlength="64">
                        </div>

                        <button class="btn btn-primary" onclick="validarCertificado()">
                            <i class="bi bi-shield-check"></i> Validar Certificado
                        </button>

                        <div id="resultadoValidacao" style="display: none;" class="mt-4">
                            <!-- Resultado da valida√ß√£o -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const API_URL = 'http://177.44.248.118:8000/api';
const LARAVEL_TOKEN = '70|VaI5IynnhSWh5OcaRzbL4mZq4WnXSjPDf003cqSE65c407fe';
    let usuario = null;

    const getHeaders = () => ({
        'Authorization': `Bearer ${LARAVEL_TOKEN}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    });


        // Verificar autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const usuarioData = localStorage.getItem('usuario');
            
            if (!usuarioData) {
                window.location.href = 'login.html';
                return;
            }

            usuario = JSON.parse(usuarioData);
            document.getElementById('nomeUsuario').textContent = usuario.nome;

            carregarCertificados();
        });

        // Quando a aba "Emitir Novo" for aberta
        document.getElementById('emitir-tab').addEventListener('click', function() {
            carregarEventosParaEmissao();
        });

        // ==================== MEUS CERTIFICADOS ====================
        async function carregarCertificados() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('certificadosContainer');

            loading.style.display = 'block';
            container.style.display = 'none';

            try {
        const response = await fetch(`${API_URL}/certificados/usuario/${usuario.id}`, {
            headers: getHeaders()
        });
                const data = await response.json();

                console.log('üìã Certificados recebidos:', data);

                if (data.success && data.data) {
                    exibirCertificados(data.data);
                } else {
                    exibirCertificados([]);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar certificados:', error);
                exibirCertificados([]);
            }
        }

        function exibirCertificados(certificados) {
            const loading = document.getElementById('loading');
            const container = document.getElementById('certificadosContainer');

            loading.style.display = 'none';
            container.style.display = 'block';
            container.innerHTML = '';

            if (certificados.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3">Nenhum certificado emitido</h4>
                        <p class="text-muted">Participe de eventos e emita seus certificados!</p>
                    </div>
                `;
                return;
            }

            certificados.forEach(cert => {
                const dataEmissao = new Date(cert.data_emissao).toLocaleDateString('pt-BR');
                
                container.innerHTML += `
                    <div class="card certificate-card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="card-title">
                                        <i class="bi bi-award text-warning"></i> ${cert.evento.titulo}
                                    </h5>
                                    <p class="mb-2">
                                        <strong>Data de Emiss√£o:</strong> ${dataEmissao}<br>
                                        <strong>Per√≠odo do Evento:</strong> ${cert.evento.data_inicio} - ${cert.evento.data_fim}<br>
                                        <strong>C√≥digo de Valida√ß√£o:</strong><br>
                                        <code class="text-primary">${cert.codigo_validacao}</code>
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-outline-primary mb-2 w-100" onclick="copiarCodigo('${cert.codigo_validacao}')">
                                        <i class="bi bi-clipboard"></i> Copiar C√≥digo
                                    </button>
                                    <a href="${cert.url_validacao}" target="_blank" class="btn btn-outline-success w-100">
                                        <i class="bi bi-shield-check"></i> Validar Online
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function copiarCodigo(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarAlerta('‚úÖ C√≥digo copiado para a √°rea de transfer√™ncia!', 'success');
            });
        }

        // ==================== EMITIR CERTIFICADO ====================
        async function carregarEventosParaEmissao() {
            const select = document.getElementById('eventoSelectEmitir');
            const loading = document.getElementById('loadingEventos');
            
            loading.style.display = 'block';
            select.innerHTML = '<option value="">Carregando...</option>';
            
    try {
        // 1Ô∏è‚É£ Buscar inscri√ß√µes do usu√°rio
        console.log(`üîç Buscando inscri√ß√µes do usu√°rio ${usuario.id}...`);
        
        const inscricoesResponse = await fetch(`${API_URL}/usuarios/${usuario.id}/inscricoes`, {
            headers: getHeaders()
        });
        
        const inscricoesData = await inscricoesResponse.json();
        console.log('üìã Inscri√ß√µes recebidas:', inscricoesData);
        
        if (!inscricoesData.success || !inscricoesData.data) {
            select.innerHTML = '<option value="">Nenhuma inscri√ß√£o encontrada</option>';
            loading.style.display = 'none';
            return;
        }

                // 2Ô∏è‚É£ Filtrar apenas inscri√ß√µes com presen√ßa
                const inscricoesComPresenca = inscricoesData.data.filter(insc => {
                    return insc.possui_presenca === true || insc.possui_presenca === 1;
                });

                console.log(`‚úÖ Inscri√ß√µes com presen√ßa: ${inscricoesComPresenca.length}`);

                // 3Ô∏è‚É£ Buscar certificados j√° emitidos
        const certResponse = await fetch(`${API_URL}/certificados/usuario/${usuario.id}`, {
            headers: getHeaders()
        });

        const certData = await certResponse.json();
                let certificadosEmitidos = [];
                if (certData.success && certData.data) {
                    certificadosEmitidos = certData.data.map(cert => cert.evento.id);
                }

                console.log('üéì Certificados j√° emitidos para eventos:', certificadosEmitidos);


                const eventosDisponiveis = inscricoesComPresenca.filter(insc => {
                    return !certificadosEmitidos.includes(insc.evento.id);
                });

                console.log(`üìä Eventos dispon√≠veis para emiss√£o: ${eventosDisponiveis.length}`);

                select.innerHTML = '<option value="">Selecione um evento</option>';

                if (eventosDisponiveis.length === 0) {
                    if (inscricoesComPresenca.length === 0) {
                        select.innerHTML = '<option value="">Voc√™ n√£o tem inscri√ß√µes com presen√ßa registrada</option>';
                    } else {
                        select.innerHTML = '<option value="">Todos os certificados j√° foram emitidos</option>';
                    }
                } else {
                    eventosDisponiveis.forEach(insc => {
                        const dataEvento = new Date(insc.evento.data_inicio).toLocaleDateString('pt-BR');
                        select.innerHTML += `
                            <option value="${insc.evento.id}" data-titulo="${insc.evento.titulo}" data-local="${insc.evento.local}">
                                ${insc.evento.titulo} - ${dataEvento}
                            </option>
                        `;
                    });
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar eventos:', error);
                select.innerHTML = '<option value="">Erro ao carregar eventos</option>';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Mostrar info do evento selecionado
        document.getElementById('eventoSelectEmitir').addEventListener('change', async function() {
            const eventoId = this.value;
            const infoDiv = document.getElementById('eventoInfoEmitir');

            if (!eventoId) {
                infoDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/eventos/${eventoId}`);
                const data = await response.json();

                if (data.success) {
                    const evento = data.data;
                    const dataInicio = new Date(evento.data_inicio).toLocaleDateString('pt-BR');
                    const dataFim = new Date(evento.data_fim).toLocaleDateString('pt-BR');

                    infoDiv.innerHTML = `
                        <strong>üìÖ Per√≠odo:</strong> ${dataInicio} a ${dataFim}<br>
                        <strong>üìç Local:</strong> ${evento.local}<br>
                        <strong>‚úÖ Status:</strong> Presen√ßa registrada
                    `;
                    infoDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar info do evento:', error);
            }
        });

        async function emitirCertificado() {
            const eventoId = document.getElementById('eventoSelectEmitir').value;

            if (!eventoId) {
                mostrarAlerta('‚ö†Ô∏è Selecione um evento!', 'warning');
                return;
            }

            try {
                mostrarAlerta('‚è≥ Emitindo certificado...', 'info');

                const response = await fetch(`${API_URL}/certificados`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        usuario_id: usuario.id,
                        evento_id: parseInt(eventoId)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta('‚úÖ Certificado emitido com sucesso!', 'success');
                    
                    // Voltar para aba de certificados
                    document.getElementById('meus-tab').click();
                    await carregarCertificados();
                    
                    // Limpar sele√ß√£o
                    document.getElementById('eventoSelectEmitir').value = '';
                    document.getElementById('eventoInfoEmitir').style.display = 'none';
                } else {
                    mostrarAlerta(`‚ùå ${data.message}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                mostrarAlerta('‚ùå Erro ao emitir certificado', 'danger');
            }
        }

        // ==================== VALIDAR CERTIFICADO ====================
        async function validarCertificado() {
            const codigo = document.getElementById('codigoValidacao').value.trim();
            const resultado = document.getElementById('resultadoValidacao');

            if (!codigo) {
                mostrarAlerta('‚ö†Ô∏è Digite o c√≥digo de valida√ß√£o!', 'warning');
                return;
            }

            resultado.style.display = 'none';

            try {
        const response = await fetch(`${API_URL}/certificados/${codigo}`, {
            headers: getHeaders()
        });
                const data = await response.json();

                if (data.success && data.valido) {
                    resultado.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="bi bi-check-circle"></i> Certificado V√°lido!</h5>
                            <hr>
                            <p><strong>Participante:</strong> ${data.data.participante.nome}</p>
                            <p><strong>Evento:</strong> ${data.data.evento.titulo}</p>
                            <p><strong>Per√≠odo:</strong> ${data.data.evento.data_inicio} - ${data.data.evento.data_fim}</p>
                            <p><strong>Local:</strong> ${data.data.evento.local}</p>
                            <p><strong>Data de Emiss√£o:</strong> ${data.data.data_emissao}</p>
                        </div>
                    `;
                } else {
                    resultado.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-x-circle"></i> Certificado Inv√°lido</h5>
                            <p class="mb-0">O c√≥digo informado n√£o foi encontrado ou √© inv√°lido.</p>
                        </div>
                    `;
                }
                
                resultado.style.display = 'block';

            } catch (error) {
                console.error('Erro:', error);
                mostrarAlerta('‚ùå Erro ao validar certificado', 'danger');
            }
        }

        // ==================== UTILIT√ÅRIOS ====================
        function mostrarAlerta(mensagem, tipo) {
            const container = document.getElementById('alertContainer');
            const icone = tipo === 'success' ? 'check-circle' : tipo === 'danger' ? 'exclamation-triangle' : 'info-circle';
            
            container.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show">
                    <i class="bi bi-${icone}"></i> ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('usuario');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
